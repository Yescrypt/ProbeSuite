#!/usr/bin/env python3
# app/exploitation/sqlmap_runner.py - SQLMap Integration

import sys
import os
import time
from datetime import datetime

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, BASE_DIR)

from config import C_OK, C_WARN, C_ERR, C_RESET, C_INFO, C_TITLE, REPORTS_DIR
from utils import Logger, pause, clear_screen, InputValidator, CommandRunner, ReportWriter, URLValidator


class SQLMapRunner:
    def __init__(self):
        self.sqlmap = "sqlmap"
        # REPORTS_DIR/exploitation/sqlmap papkasi — barcha reportlar shu yerga saqlanadi
        self.reports_dir = os.path.join(REPORTS_DIR, 'exploitation', 'sqlmap')
        # Agar papka yo'q bo'lsa — avtomatik yaratiladi
        os.makedirs(self.reports_dir, exist_ok=True)
    
    def save_report(self, filename: str, content: str):
        """
        Umumiy report saqlash funksiyasi
        filename — to'liq fayl nomi (.txt bilan)
        content  — faylga yoziladigan matn
        """
        filepath = os.path.join(self.reports_dir, filename)
        try:
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(content)
            Logger.success(f"Report saved: {filepath}")
        except Exception as e:
            Logger.error(f"Failed to save report: {e}")

    def run(self):
        """Main SQLMap menu"""
        while True:
            clear_screen()
            print(f"\n{C_TITLE}╔══════════════════════════════════════════╗")
            print(f"║         SQLMAP - SQL INJECTION           ║")
            print(f"╚══════════════════════════════════════════╝{C_RESET}\n")
            
            print(f"{C_INFO}  [1]  Basic SQL Injection Test{C_RESET}")
            print(f"{C_INFO}  [2]  Database Enumeration{C_RESET}")
            print(f"{C_INFO}  [3]  Extract Database Names{C_RESET}")
            print(f"{C_INFO}  [4]  Extract Tables{C_RESET}")
            print(f"{C_INFO}  [5]  Dump Specific Table{C_RESET}")
            print(f"{C_INFO}  [6]  Custom SQLMap Command{C_RESET}")
            print(f"\n{C_WARN}  [0]  Back{C_RESET}\n")
            
            choice = InputValidator.get_choice()
            
            if choice == '0':
                return
            elif choice == '1':
                self.basic_injection_test()
            elif choice == '2':
                self.database_enumeration()
            elif choice == '3':
                self.extract_databases()
            elif choice == '4':
                self.extract_tables()
            elif choice == '5':
                self.dump_table()
            elif choice == '6':
                self.custom_command()
            else:
                Logger.error("Invalid choice!")
                time.sleep(1)
    
    def basic_injection_test(self):
        """Basic SQL Injection Test"""
        clear_screen()
        print(f"\n{C_TITLE}═══ BASIC SQL INJECTION TEST ═══{C_RESET}\n")

        # URL MISOLLARI
        print(f"{C_INFO}Example URLs:{C_RESET}")
        print(f"  • http://testsite.com/product.php?id=1")
        print(f"  • http://example.com/news.php?article=5\n")
        
        if not CommandRunner.check_tool('sqlmap'):
            Logger.error("SQLMap not installed!")
            Logger.info("Install: sudo apt install sqlmap")
            pause()
            return
        
        url = InputValidator.get_url()
        if not url:
            return
        
        # URL parametr borligini tekshirish
        if '?' not in url:
            # Logger.warn() o'rniga Logger.info() yoki print() ishlatamiz
            print(f"{C_WARN}⚠️  URL contains no parameters!{C_RESET}")
            print(f"\n{C_INFO}Options:{C_RESET}")
            print(f"  1. Add parameters manually (e.g., ?id=1)")
            print(f"  2. Use --crawl to find testable URLs")
            print(f"  3. Cancel\n")
            
            choice = input(f"{C_INFO}Choose option [1-3]: {C_RESET}").strip()
            
            if choice == '1':
                param = input(f"{C_INFO}Enter parameters (e.g., ?id=1): {C_RESET}").strip()
                if param:
                    if not param.startswith('?'):
                        param = '?' + param
                    url += param
            elif choice == '2':
                # Crawl qo'shish
                cmd = f"sqlmap -u '{url}' --batch --crawl=2 --risk=1 --level=1"
                Logger.info("Crawling for testable parameters...")
                
                # Bu yerda cmd o'zgaruvchisi allaqachon o'zgartirilgan, shuning uchun keyingi qismda ishlatiladi
            else:
                return
        
        domain = URLValidator.extract_domain(url)
        Logger.info(f"Target URL: {url}")
        Logger.info("Testing for SQL injection vulnerabilities...")
        
        # Agar crawl tanlanmagan bo'lsa, oddiy cmd ishlatiladi
        if '?' not in url or choice != '2':
            cmd = f"sqlmap -u '{url}' --batch --risk=1 --level=1"
        
        print(f"\n{C_INFO}Command:{C_RESET}")
        print(f"{cmd}\n")
        
        pause("Press Enter to start testing...")
        
        timestamp = ReportWriter.get_timestamp()
        Logger.info("Running SQLMap (this may take a while)...")
        
        returncode, stdout, stderr = CommandRunner.run(cmd, shell=True, timeout=600)
        
        print(stdout)
        
        # Save report
        report_content = f"""SQLMAP - BASIC SQL INJECTION TEST
    {'='*80}
    Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
    Target URL: {url}
    Test Level: 1
    Risk Level: 1
    {'='*80}

    COMMAND EXECUTED:
    {cmd}

    RESULTS:
    {stdout}

    """
        
        if "sqlmap identified" in stdout.lower() or "parameter" in stdout.lower():
            report_content += "STATUS: Potential SQL injection vulnerability found!\n"
            Logger.success("Potential SQL injection found!")
        else:
            report_content += "STATUS: No SQL injection detected\n"
            Logger.info("No SQL injection detected")
        
        report_content += f"\n{'='*80}\n"
        
        filename = f"sqlmap_basic_{domain}_{timestamp}.txt"
        self.save_report(filename, report_content)
        pause()
    
    def database_enumeration(self):
        """Database Enumeration"""
        clear_screen()
        print(f"\n{C_TITLE}═══ DATABASE ENUMERATION ═══{C_RESET}\n")

        # URL MISOLLARI
        print(f"{C_INFO}Example URLs:{C_RESET}")
        print(f"  • http://testsite.com/product.php?id=1")
        print(f"  • http://admin.site.uz/panel.php?user_id=5\n")
        
        if not CommandRunner.check_tool('sqlmap'):
            Logger.error("SQLMap not installed!")
            pause()
            return
        
        url = InputValidator.get_url()
        if not url:
            return
        
        domain = URLValidator.extract_domain(url)
        Logger.info(f"Target URL: {url}")
        Logger.info("Enumerating database information...")
        
        cmd = f"sqlmap -u '{url}' --batch --banner --current-user --current-db --is-dba"
        
        print(f"\n{C_INFO}Command:{C_RESET}")
        print(f"{cmd}\n")
        
        pause("Press Enter to start enumeration...")
        
        timestamp = ReportWriter.get_timestamp()
        Logger.info("Running SQLMap enumeration...")
        
        returncode, stdout, stderr = CommandRunner.run(cmd, shell=True, timeout=600)
        
        print(stdout)
        
        # Save report
        report_content = f"""SQLMAP - DATABASE ENUMERATION
{'='*80}
Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Target URL: {url}
{'='*80}

COMMAND EXECUTED:
{cmd}

DATABASE INFORMATION:
{stdout}

{'='*80}
"""
        
        filename = f"sqlmap_enum_{domain}_{timestamp}.txt"
        self.save_report(filename, report_content)
        pause()
    
    def extract_databases(self):
        """Extract Database Names"""
        clear_screen()
        print(f"\n{C_TITLE}═══ EXTRACT DATABASE NAMES ═══{C_RESET}\n")

            # URL MISOLLARI
        print(f"{C_INFO}Example URLs:{C_RESET}")
        print(f"  • http://shop.uz/category.php?cat_id=10")
        print(f"  • http://blog.com/post.php?id=23\n")
        
        if not CommandRunner.check_tool('sqlmap'):
            Logger.error("SQLMap not installed!")
            pause()
            return
        
        url = InputValidator.get_url()
        if not url:
            return
        
        domain = URLValidator.extract_domain(url)
        Logger.info(f"Target URL: {url}")
        Logger.info("Extracting database names...")
        
        cmd = f"sqlmap -u '{url}' --batch --dbs"
        
        print(f"\n{C_INFO}Command:{C_RESET}")
        print(f"{cmd}\n")
        
        pause("Press Enter to extract databases...")
        
        timestamp = ReportWriter.get_timestamp()
        Logger.info("Running SQLMap...")
        
        returncode, stdout, stderr = CommandRunner.run(cmd, shell=True, timeout=600)
        
        print(stdout)
        
        # Save report
        report_content = f"""SQLMAP - DATABASE NAMES EXTRACTION
{'='*80}
Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Target URL: {url}
{'='*80}

COMMAND EXECUTED:
{cmd}

DATABASES FOUND:
{stdout}

{'='*80}
"""
        
        filename = f"sqlmap_databases_{domain}_{timestamp}.txt"
        self.save_report(filename, report_content)
        pause()
    
    def extract_tables(self):
        """Extract Tables"""
        clear_screen()
        print(f"\n{C_TITLE}═══ EXTRACT TABLES ═══{C_RESET}\n")

            # URL MISOLLARI
        print(f"{C_INFO}Example URLs:{C_RESET}")
        print(f"  • http://testsite.com/product.php?id=1")
        print(f"  • http://shop.uz/item.php?cat=5\n")
        
        if not CommandRunner.check_tool('sqlmap'):
            Logger.error("SQLMap not installed!")
            pause()
            return
        
        url = InputValidator.get_url()
        if not url:
            return
        
        print()
        database = input(f"{C_INFO}Enter database name: {C_RESET}").strip()
        
        if not database:
            Logger.error("Database name required!")
            pause()
            return
        
        Logger.info(f"Target URL: {url}")
        Logger.info(f"Database: {database}")
        Logger.info("Extracting tables...")
        
        cmd = f"sqlmap -u '{url}' --batch -D {database} --tables"
        
        print(f"\n{C_INFO}Command:{C_RESET}")
        print(f"{cmd}\n")
        
        pause("Press Enter to extract tables...")
        
        timestamp = ReportWriter.get_timestamp()
        Logger.info("Running SQLMap...")
        
        returncode, stdout, stderr = CommandRunner.run(cmd, shell=True, timeout=600)
        
        print(stdout)
        
        # Save report
        report_content = f"""SQLMAP - TABLES EXTRACTION
{'='*80}
Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Target URL: {url}
Database: {database}
{'='*80}

COMMAND EXECUTED:
{cmd}

TABLES FOUND:
{stdout}

{'='*80}
"""
        
        filename = f"sqlmap_tables_{database}_{timestamp}.txt"
        self.save_report(filename, report_content)
        pause()
    
    def dump_table(self):
        """Dump Specific Table"""
        clear_screen()
        print(f"\n{C_TITLE}═══ DUMP TABLE DATA ═══{C_RESET}\n")

            # URL MISOLLARI
        print(f"{C_INFO}Example URLs:{C_RESET}")
        print(f"  • http://testsite.com/product.php?id=1")
        print(f"  • http://admin.site.uz/panel.php?user_id=5\n")
        
        if not CommandRunner.check_tool('sqlmap'):
            Logger.error("SQLMap not installed!")
            pause()
            return
        
        url = InputValidator.get_url()
        if not url:
            return
        
        print()
        database = input(f"{C_INFO}Enter database name: {C_RESET}").strip()
        table = input(f"{C_INFO}Enter table name: {C_RESET}").strip()
        
        if not database or not table:
            Logger.error("Database and table name required!")
            pause()
            return
        
        Logger.info(f"Target URL: {url}")
        Logger.info(f"Database: {database}")
        Logger.info(f"Table: {table}")
        Logger.info("Dumping table data...")
        
        cmd = f"sqlmap -u '{url}' --batch -D {database} -T {table} --dump"
        
        print(f"\n{C_INFO}Command:{C_RESET}")
        print(f"{cmd}\n")
        
        pause("Press Enter to dump table...")
        
        timestamp = ReportWriter.get_timestamp()
        Logger.info("Running SQLMap (this may take a while)...")
        
        returncode, stdout, stderr = CommandRunner.run(cmd, shell=True, timeout=900)
        
        print(stdout)
        
        # Save report
        report_content = f"""SQLMAP - TABLE DUMP
{'='*80}
Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Target URL: {url}
Database: {database}
Table: {table}
{'='*80}

COMMAND EXECUTED:
{cmd}

TABLE DATA:
{stdout}

{'='*80}
"""
        
        filename = f"sqlmap_dump_{database}_{table}_{timestamp}.txt"
        self.save_report(filename, report_content)
        Logger.info("Check SQLMap output directory for CSV dump files")
        pause()
    
    def custom_command(self):
        """Custom SQLMap Command"""
        clear_screen()
        print(f"\n{C_TITLE}═══ CUSTOM SQLMAP COMMAND ═══{C_RESET}\n")

            # URL MISOLLARI
        print(f"{C_INFO}Example URLs:{C_RESET}")
        print(f"  • http://testsite.com/search.php?q=test")
        print(f"  • http://site.com/login.php (for POST data)\n")
        
        if not CommandRunner.check_tool('sqlmap'):
            Logger.error("SQLMap not installed!")
            pause()
            return
        
        url = InputValidator.get_url()
        if not url:
            return
        
        domain = URLValidator.extract_domain(url)
        
        print()
        print(f"{C_INFO}Common SQLMap options:{C_RESET}")
        print(f"  --batch              : Never ask for user input")
        print(f"  --dbs                : Enumerate databases")
        print(f"  --tables             : Enumerate tables")
        print(f"  --columns            : Enumerate columns")
        print(f"  --dump               : Dump table data")
        print(f"  -D <db>              : Specify database")
        print(f"  -T <table>           : Specify table")
        print(f"  --risk=1-3           : Risk level")
        print(f"  --level=1-5          : Test level")
        print(f"  --technique=BEUSTQ   : SQL injection technique\n")
        
        custom_args = input(f"{C_INFO}Enter custom SQLMap arguments: {C_RESET}").strip()
        
        if not custom_args:
            Logger.error("No arguments provided!")
            pause()
            return
        
        cmd = f"sqlmap -u '{url}' {custom_args}"
        
        print(f"\n{C_INFO}Full Command:{C_RESET}")
        print(f"{cmd}\n")
        
        if not InputValidator.confirm("Execute this command?"):
            return
        
        timestamp = ReportWriter.get_timestamp()
        Logger.info("Running SQLMap...")
        
        returncode, stdout, stderr = CommandRunner.run(cmd, shell=True, timeout=900)
        
        print(stdout)
        
        # Save report
        report_content = f"""SQLMAP - CUSTOM COMMAND
{'='*80}
Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Target URL: {url}
{'='*80}

COMMAND EXECUTED:
{cmd}

OUTPUT:
{stdout}

{'='*80}
"""
        
        filename = f"sqlmap_custom_{domain}_{timestamp}.txt"
        self.save_report(filename, report_content)
        pause()


if __name__ == "__main__":
    runner = SQLMapRunner()
    runner.run()