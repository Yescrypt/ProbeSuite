#!/usr/bin/env python3
# app/vulnerability/cve_checker.py - CVE Database Lookup

import requests
import sys
import os
import json
from datetime import datetime

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, BASE_DIR)

from config import C_OK, C_WARN, C_ERR, C_RESET, C_INFO, C_TITLE, REQUEST_TIMEOUT
from utils import Logger, pause, clear_screen, InputValidator, ReportWriter

class CVEChecker:
    def __init__(self):
        self.nvd_api = "https://services.nvd.nist.gov/rest/json/cves/2.0"
        self.cvedetails_api = "https://www.cvedetails.com/json-feed.php"
        self.results = []
    
    def run(self):
        """Main CVE checker"""
        clear_screen()
        print(f"\n{C_TITLE}╔══════════════════════════════════════════╗")
        print(f"║        CVE DATABASE LOOKUP               ║")
        print(f"╚══════════════════════════════════════════╝{C_RESET}\n")
        
        print(f"{C_INFO}Examples:{C_RESET}")
        print(f"  CVE ID: CVE-2021-44228 (Log4Shell)")
        print(f"  Keyword: apache, windows, ssh")
        print(f"  Product: apache/http_server, microsoft/windows\n")
        
        print(f"{C_INFO}Search Options:{C_RESET}")
        print(f"  [1] Search by CVE ID")
        print(f"  [2] Search by keyword")
        print(f"  [3] Search by product/version")
        print(f"  [0] Back\n")
        
        choice = InputValidator.get_choice()
        
        if choice == '0':
            return
        elif choice == '1':
            self.search_by_cve_id()
        elif choice == '2':
            self.search_by_keyword()
        elif choice == '3':
            self.search_by_product()
        else:
            Logger.error("Invalid choice!")
            pause()
            return
        
        if self.results:
            self.display_results()
            self.save_report()
        
        pause()
    
    def search_by_cve_id(self):
        """Search by specific CVE ID"""
        clear_screen()
        print(f"\n{C_TITLE}═══ CVE ID LOOKUP ═══{C_RESET}\n")
        
        cve_id = input(f"{C_INFO}Enter CVE ID (e.g., CVE-2021-44228): {C_RESET}").strip().upper()
        
        if not cve_id.startswith('CVE-'):
            Logger.error("Invalid CVE ID format! Should be CVE-YYYY-NNNNN")
            return
        
        Logger.info(f"Searching for {cve_id}...")
        
        try:
            # Try NVD API
            url = f"{self.nvd_api}?cveId={cve_id}"
            response = requests.get(url, timeout=REQUEST_TIMEOUT)
            
            if response.status_code == 200:
                data = response.json()
                
                if data.get('totalResults', 0) > 0:
                    vuln = data['vulnerabilities'][0]['cve']
                    
                    result = {
                        'cve_id': cve_id,
                        'description': vuln.get('descriptions', [{}])[0].get('value', 'N/A'),
                        'published': vuln.get('published', 'N/A'),
                        'lastModified': vuln.get('lastModified', 'N/A'),
                        'cvss_v3': self.extract_cvss_v3(vuln),
                        'cvss_v2': self.extract_cvss_v2(vuln),
                        'references': [ref['url'] for ref in vuln.get('references', [])[:5]]
                    }
                    
                    self.results.append(result)
                    Logger.success(f"Found CVE: {cve_id}")
                else:
                    Logger.warning(f"CVE not found: {cve_id}")
            else:
                Logger.error(f"API request failed: {response.status_code}")
                
        except Exception as e:
            Logger.error(f"Search failed: {e}")
    
    def search_by_keyword(self):
        """Search by keyword"""
        clear_screen()
        print(f"\n{C_TITLE}═══ KEYWORD SEARCH ═══{C_RESET}\n")
        
        keyword = input(f"{C_INFO}Enter keyword (e.g., apache, windows, ssh): {C_RESET}").strip()
        
        if not keyword:
            Logger.error("Keyword cannot be empty!")
            return
        
        Logger.info(f"Searching for vulnerabilities related to '{keyword}'...")
        Logger.warning("This may take a few moments...")
        
        try:
            # Use NVD API with keyword
            url = f"{self.nvd_api}?keywordSearch={keyword}&resultsPerPage=10"
            response = requests.get(url, timeout=30)
            
            if response.status_code == 200:
                data = response.json()
                total = data.get('totalResults', 0)
                
                Logger.info(f"Found {total} results (showing first 10)")
                
                if total > 0:
                    for vuln_data in data.get('vulnerabilities', []):
                        vuln = vuln_data['cve']
                        
                        result = {
                            'cve_id': vuln.get('id', 'N/A'),
                            'description': vuln.get('descriptions', [{}])[0].get('value', 'N/A')[:200] + '...',
                            'published': vuln.get('published', 'N/A'),
                            'cvss_v3': self.extract_cvss_v3(vuln),
                            'cvss_v2': self.extract_cvss_v2(vuln),
                        }
                        
                        self.results.append(result)
                    
                    Logger.success(f"Retrieved {len(self.results)} CVEs")
                else:
                    Logger.warning(f"No vulnerabilities found for '{keyword}'")
            else:
                Logger.error(f"API request failed: {response.status_code}")
                
        except Exception as e:
            Logger.error(f"Search failed: {e}")
    
    def search_by_product(self):
        """Search by product and version"""
        clear_screen()
        print(f"\n{C_TITLE}═══ PRODUCT/VERSION SEARCH ═══{C_RESET}\n")
        
        vendor = input(f"{C_INFO}Enter vendor (e.g., apache, microsoft): {C_RESET}").strip()
        product = input(f"{C_INFO}Enter product (e.g., http_server, windows): {C_RESET}").strip()
        version = input(f"{C_INFO}Enter version (optional): {C_RESET}").strip()
        
        if not vendor or not product:
            Logger.error("Vendor and product are required!")
            return
        
        Logger.info(f"Searching for {vendor}/{product} vulnerabilities...")
        
        try:
            # Build CPE string
            cpe = f"cpe:2.3:a:{vendor}:{product}"
            if version:
                cpe += f":{version}"
            
            url = f"{self.nvd_api}?cpeName={cpe}&resultsPerPage=10"
            response = requests.get(url, timeout=30)
            
            if response.status_code == 200:
                data = response.json()
                total = data.get('totalResults', 0)
                
                Logger.info(f"Found {total} results (showing first 10)")
                
                if total > 0:
                    for vuln_data in data.get('vulnerabilities', []):
                        vuln = vuln_data['cve']
                        
                        result = {
                            'cve_id': vuln.get('id', 'N/A'),
                            'description': vuln.get('descriptions', [{}])[0].get('value', 'N/A')[:200] + '...',
                            'published': vuln.get('published', 'N/A'),
                            'cvss_v3': self.extract_cvss_v3(vuln),
                            'cvss_v2': self.extract_cvss_v2(vuln),
                        }
                        
                        self.results.append(result)
                    
                    Logger.success(f"Retrieved {len(self.results)} CVEs")
                else:
                    Logger.warning(f"No vulnerabilities found for {vendor}/{product}")
            else:
                Logger.error(f"API request failed: {response.status_code}")
                
        except Exception as e:
            Logger.error(f"Search failed: {e}")
    
    def extract_cvss_v3(self, vuln):
        """Extract CVSS v3 score"""
        try:
            metrics = vuln.get('metrics', {})
            cvss_v3 = metrics.get('cvssMetricV31', [{}])[0] or metrics.get('cvssMetricV30', [{}])[0]
            
            if cvss_v3:
                cvss_data = cvss_v3.get('cvssData', {})
                return {
                    'score': cvss_data.get('baseScore', 'N/A'),
                    'severity': cvss_data.get('baseSeverity', 'N/A'),
                    'vector': cvss_data.get('vectorString', 'N/A')
                }
        except:
            pass
        
        return {'score': 'N/A', 'severity': 'N/A', 'vector': 'N/A'}
    
    def extract_cvss_v2(self, vuln):
        """Extract CVSS v2 score"""
        try:
            metrics = vuln.get('metrics', {})
            cvss_v2 = metrics.get('cvssMetricV2', [{}])[0]
            
            if cvss_v2:
                cvss_data = cvss_v2.get('cvssData', {})
                return {
                    'score': cvss_data.get('baseScore', 'N/A'),
                    'severity': cvss_v2.get('baseSeverity', 'N/A')
                }
        except:
            pass
        
        return {'score': 'N/A', 'severity': 'N/A'}
    
    def display_results(self):
        """Display search results"""
        print(f"\n{C_TITLE}{'='*80}")
        print(f"CVE SEARCH RESULTS")
        print(f"{'='*80}{C_RESET}\n")
        
        for i, result in enumerate(self.results, 1):
            cvss_v3 = result.get('cvss_v3', {})
            score = cvss_v3.get('score', 'N/A')
            severity = cvss_v3.get('severity', 'N/A')
            
            # Color by severity
            if severity == 'CRITICAL':
                color = C_ERR
            elif severity == 'HIGH':
                color = C_WARN
            else:
                color = C_INFO
            
            print(f"{color}[{i}] {result['cve_id']}{C_RESET}")
            print(f"  Published: {result.get('published', 'N/A')}")
            print(f"  CVSS v3: {score} ({severity})")
            print(f"  Description: {result.get('description', 'N/A')[:150]}...")
            
            if 'references' in result:
                print(f"  References:")
                for ref in result['references'][:3]:
                    print(f"    - {ref}")
            
            print()
    
    def save_report(self):
        """Save search results"""
        if not self.results:
            return
        
        timestamp = ReportWriter.get_timestamp()
        filename = f"cve_lookup_{timestamp}"
        
        report_data = {
            'search_date': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            'total_results': len(self.results),
            'cves': self.results
        }
        
        # Save JSON
        ReportWriter.save_json(filename, report_data, subfolder='vulnerability/cve_lookup')
        
        # Save TXT
        txt_content = ReportWriter.create_report_header("CVE DATABASE LOOKUP REPORT", "CVE Search")
        txt_content += f"Total Results: {len(self.results)}\n\n"
        
        for i, result in enumerate(self.results, 1):
            txt_content += f"[{i}] {result['cve_id']}\n"
            txt_content += "=" * 80 + "\n"
            txt_content += f"Published: {result.get('published', 'N/A')}\n"
            
            cvss_v3 = result.get('cvss_v3', {})
            txt_content += f"CVSS v3 Score: {cvss_v3.get('score', 'N/A')}\n"
            txt_content += f"Severity: {cvss_v3.get('severity', 'N/A')}\n"
            
            if 'vector' in cvss_v3 and cvss_v3['vector'] != 'N/A':
                txt_content += f"Vector: {cvss_v3['vector']}\n"
            
            txt_content += f"\nDescription:\n{result.get('description', 'N/A')}\n"
            
            if 'references' in result:
                txt_content += "\nReferences:\n"
                for ref in result['references']:
                    txt_content += f"  - {ref}\n"
            
            txt_content += "\n" + "=" * 80 + "\n\n"
        
        ReportWriter.save_txt(filename, txt_content, subfolder='vulnerability/cve_lookup')

if __name__ == "__main__":
    checker = CVEChecker()
    checker.run()