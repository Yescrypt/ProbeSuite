#!/usr/bin/env python3
# app/post_exploitation/post_exploitation_menu.py

import sys
import os
import time

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, BASE_DIR)

from config import C_OK, C_WARN, C_ERR, C_RESET, C_INFO, C_TITLE
from utils import Logger, pause, InputValidator, clear_screen


class Terminal:
    MARGIN = 4
    
    @staticmethod
    def print_margin(text=""):
        margin = ' ' * Terminal.MARGIN
        if text:
            print(margin + text)
        else:
            print()


def show_header():
    """Show Post Exploitation header"""
    clear_screen()
    Terminal.print_margin()
    Terminal.print_margin(f"{C_TITLE}╔════════════════════════════════════════╗{C_RESET}")
    Terminal.print_margin(f"{C_TITLE}║      POST EXPLOITATION FRAMEWORK       ║{C_RESET}")
    Terminal.print_margin(f"{C_TITLE}╚════════════════════════════════════════╝{C_RESET}")
    Terminal.print_margin()


def run_post_exploitation_menu():
    """Main Post Exploitation Menu"""
    while True:
        show_header()
        
        Terminal.print_margin(f"{C_TITLE}┌─ POST EXPLOITATION MENU ────────────┐{C_RESET}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_INFO}  SYSTEM ACCESS:{C_RESET}")
        Terminal.print_margin(f"{C_INFO}  [1]  Privilege Escalation{C_RESET}")
        Terminal.print_margin(f"{C_INFO}  [2]  Persistence Mechanisms{C_RESET}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_INFO}  DATA OPERATIONS:{C_RESET}")
        Terminal.print_margin(f"{C_INFO}  [3]  Data Extraction{C_RESET}")
        Terminal.print_margin(f"{C_INFO}  [4]  Credential Harvesting{C_RESET}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_INFO}  NETWORK:{C_RESET}")
        Terminal.print_margin(f"{C_INFO}  [5]  Lateral Movement{C_RESET}")
        Terminal.print_margin(f"{C_INFO}  [6]  Network Discovery{C_RESET}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_INFO}  STEALTH:{C_RESET}")
        Terminal.print_margin(f"{C_INFO}  [7]  Log Cleaner{C_RESET}")
        Terminal.print_margin(f"{C_INFO}  [8]  Anti-Forensics{C_RESET}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_WARN}  [0]  Back to Main Menu{C_RESET}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_TITLE}└─────────────────────────────────────┘{C_RESET}")
        Terminal.print_margin()
        
        choice = InputValidator.get_choice()
        
        if choice == '0':
            return
        elif choice == '1':
            run_privilege_escalation()
        elif choice == '2':
            run_persistence()
        elif choice == '3':
            run_data_extraction()
        elif choice == '4':
            run_credential_harvesting()
        elif choice == '5':
            run_lateral_movement()
        elif choice == '6':
            run_network_discovery()
        elif choice == '7':
            run_log_cleaner()
        elif choice == '8':
            run_anti_forensics()
        else:
            Logger.error("Invalid choice!")
            time.sleep(0.5)


def run_privilege_escalation():
    """Run Privilege Escalation module"""
    try:
        from privilege_escalation import PrivilegeEscalation
        priv_esc = PrivilegeEscalation()
        priv_esc.run()
    except ImportError as e:
        Logger.error(f"Privilege Escalation module not found!")
        Logger.warning(f"Error: {e}")
        pause()
    except Exception as e:
        Logger.error(f"Error: {e}")
        pause()


def run_persistence():
    """Run Persistence module"""
    try:
        from persistence import Persistence
        persist = Persistence()
        persist.run()
    except ImportError as e:
        Logger.error(f"Persistence module not found!")
        Logger.warning(f"Error: {e}")
        pause()
    except Exception as e:
        Logger.error(f"Error: {e}")
        pause()


def run_data_extraction():
    """Run Data Extraction module"""
    try:
        from data_extraction import DataExtraction
        data_ext = DataExtraction()
        data_ext.run()
    except ImportError as e:
        Logger.error(f"Data Extraction module not found!")
        Logger.warning(f"Error: {e}")
        pause()
    except Exception as e:
        Logger.error(f"Error: {e}")
        pause()


def run_credential_harvesting():
    """Run Credential Harvesting module"""
    try:
        from credential_harvesting import CredentialHarvesting
        cred_harv = CredentialHarvesting()
        cred_harv.run()
    except ImportError as e:
        Logger.error(f"Credential Harvesting module not found!")
        Logger.warning(f"Error: {e}")
        pause()
    except Exception as e:
        Logger.error(f"Error: {e}")
        pause()


def run_lateral_movement():
    """Run Lateral Movement module"""
    try:
        from lateral_movement import LateralMovement
        lat_move = LateralMovement()
        lat_move.run()
    except ImportError as e:
        Logger.error(f"Lateral Movement module not found!")
        Logger.warning(f"Error: {e}")
        pause()
    except Exception as e:
        Logger.error(f"Error: {e}")
        pause()


def run_network_discovery():
    """Run Network Discovery module"""
    try:
        from network_discovery import NetworkDiscovery
        net_disc = NetworkDiscovery()
        net_disc.run()
    except ImportError as e:
        Logger.error(f"Network Discovery module not found!")
        Logger.warning(f"Error: {e}")
        pause()
    except Exception as e:
        Logger.error(f"Error: {e}")
        pause()


def run_log_cleaner():
    """Run Log Cleaner module"""
    try:
        from log_cleaner import LogCleaner
        log_clean = LogCleaner()
        log_clean.run()
    except ImportError as e:
        Logger.error(f"Log Cleaner module not found!")
        Logger.warning(f"Error: {e}")
        pause()
    except Exception as e:
        Logger.error(f"Error: {e}")
        pause()


def run_anti_forensics():
    """Run Anti-Forensics module"""
    Logger.warning("Anti-Forensics module under development")
    Logger.info("This will include:")
    Terminal.print_margin(f"  • Timestamp manipulation")
    Terminal.print_margin(f"  • File wiping")
    Terminal.print_margin(f"  • Memory clearing")
    Terminal.print_margin(f"  • Artifact removal")
    pause()


if __name__ == "__main__":
    run_post_exploitation_menu()