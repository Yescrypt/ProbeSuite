#!/usr/bin/env python3
# app/post_exploitation/network_discovery.py

import os
import sys
import socket
import subprocess

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, BASE_DIR)

from config import C_OK, C_WARN, C_ERR, C_RESET, C_INFO, C_TITLE
from utils import Logger, pause, InputValidator, clear_screen


class Terminal:
    MARGIN = 4
    
    @staticmethod
    def print_margin(text=""):
        margin = ' ' * Terminal.MARGIN
        if text:
            print(margin + text)
        else:
            print()


class NetworkDiscovery:
    def show_header(self):
        clear_screen()
        Terminal.print_margin()
        Terminal.print_margin(f"{C_TITLE}╔════════════════════════════════════════╗{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}║        NETWORK DISCOVERY TOOLKIT       ║{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}╚════════════════════════════════════════╝{C_RESET}")
        Terminal.print_margin()
    
    def run(self):
        while True:
            self.show_header()
            
            Terminal.print_margin(f"{C_TITLE}┌─ NETWORK DISCOVERY ─────────────────┐{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  HOST DISCOVERY:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [1]  Ping Sweep{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [2]  ARP Scan{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [3]  Local Network Info{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  PORT SCANNING:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [4]  Quick Port Scan{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [5]  Common Ports Scan{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  SERVICE DISCOVERY:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [6]  SMB Discovery{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [7]  SSH Discovery{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [8]  HTTP/HTTPS Discovery{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  ADVANCED:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [9]  Network Routing Info{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [10] Active Connections{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_WARN}  [0]  Back{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_TITLE}└─────────────────────────────────────┘{C_RESET}")
            Terminal.print_margin()
            
            choice = InputValidator.get_choice()
            
            if choice == '0':
                return
            elif choice == '1':
                self.ping_sweep()
            elif choice == '2':
                self.arp_scan()
            elif choice == '3':
                self.local_network_info()
            elif choice == '4':
                self.quick_port_scan()
            elif choice == '5':
                self.common_ports_scan()
            elif choice == '6':
                self.smb_discovery()
            elif choice == '7':
                self.ssh_discovery()
            elif choice == '8':
                self.http_discovery()
            elif choice == '9':
                self.routing_info()
            elif choice == '10':
                self.active_connections()
            else:
                Logger.error("Invalid choice!")
                pause()
    
    def ping_sweep(self):
        """Ping sweep scan"""
        self.show_header()
        Logger.info("Ping Sweep Scanner")
        Terminal.print_margin()
        
        network = input(f"{C_INFO}Enter network (e.g., 192.168.1): {C_RESET}").strip()
        
        if not network:
            pause()
            return
        
        Logger.info(f"Scanning {network}.0/24...")
        Terminal.print_margin()
        
        alive_hosts = []
        
        for i in range(1, 255):
            ip = f"{network}.{i}"
            response = os.system(f"ping -c 1 -W 1 {ip} > /dev/null 2>&1")
            
            if response == 0:
                alive_hosts.append(ip)
                Logger.info(f"[+] Host is UP: {ip}")
        
        Terminal.print_margin()
        Logger.info(f"Found {len(alive_hosts)} alive hosts")
        
        pause()
    
    def arp_scan(self):
        """ARP scan"""
        self.show_header()
        Logger.info("ARP Scan")
        Terminal.print_margin()
        
        Logger.info("Using arp-scan...")
        os.system("arp-scan -l 2>/dev/null || echo 'arp-scan not installed'")
        Terminal.print_margin()
        
        Logger.info("Alternative: netdiscover")
        Terminal.print_margin("  netdiscover -i eth0 -r 192.168.1.0/24")
        
        pause()
    
    def local_network_info(self):
        """Local network information"""
        self.show_header()
        Logger.info("Local Network Information")
        Terminal.print_margin()
        
        # Network interfaces
        Logger.info("Network Interfaces:")
        os.system("ip addr show")
        Terminal.print_margin()
        
        # Routing table
        Logger.info("Routing Table:")
        os.system("ip route show")
        Terminal.print_margin()
        
        # DNS servers
        Logger.info("DNS Servers:")
        os.system("cat /etc/resolv.conf")
        Terminal.print_margin()
        
        # ARP cache
        Logger.info("ARP Cache:")
        os.system("arp -a")
        
        pause()
    
    def quick_port_scan(self):
        """Quick port scan"""
        self.show_header()
        Logger.info("Quick Port Scanner")
        Terminal.print_margin()
        
        target = input(f"{C_INFO}Target IP: {C_RESET}").strip()
        
        if not target:
            pause()
            return
        
        Logger.info(f"Scanning {target}...")
        Terminal.print_margin()
        
        common_ports = [21, 22, 23, 25, 80, 443, 445, 3389, 8080]
        
        for port in common_ports:
            try:
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(1)
                result = sock.connect_ex((target, port))
                
                if result == 0:
                    Logger.info(f"[+] Port {port} is OPEN")
                
                sock.close()
            except:
                pass
        
        pause()
    
    def common_ports_scan(self):
        """Common ports scan with nmap"""
        self.show_header()
        Logger.info("Common Ports Scanner")
        Terminal.print_margin()
        
        target = input(f"{C_INFO}Target: {C_RESET}").strip()
        
        if not target:
            pause()
            return
        
        Logger.info(f"Scanning {target} with nmap...")
        Terminal.print_margin()
        
        cmd = f"nmap -T4 --top-ports 100 {target}"
        os.system(cmd)
        
        pause()
    
    def smb_discovery(self):
        """SMB service discovery"""
        self.show_header()
        Logger.info("SMB Service Discovery")
        Terminal.print_margin()
        
        network = input(f"{C_INFO}Network range (e.g., 192.168.1.0/24): {C_RESET}").strip()
        
        if not network:
            pause()
            return
        
        Logger.info("Scanning for SMB services (port 445)...")
        os.system(f"nmap -p 445 --open {network}")
        Terminal.print_margin()
        
        Logger.info("For detailed SMB enumeration:")
        Terminal.print_margin("  nmap -p 445 --script smb-enum-shares TARGET")
        Terminal.print_margin("  enum4linux -a TARGET")
        
        pause()
    
    def ssh_discovery(self):
        """SSH service discovery"""
        self.show_header()
        Logger.info("SSH Service Discovery")
        Terminal.print_margin()
        
        network = input(f"{C_INFO}Network range: {C_RESET}").strip()
        
        if not network:
            pause()
            return
        
        Logger.info("Scanning for SSH services (port 22)...")
        os.system(f"nmap -p 22 --open {network}")
        
        pause()
    
    def http_discovery(self):
        """HTTP/HTTPS discovery"""
        self.show_header()
        Logger.info("HTTP/HTTPS Service Discovery")
        Terminal.print_margin()
        
        network = input(f"{C_INFO}Network range: {C_RESET}").strip()
        
        if not network:
            pause()
            return
        
        Logger.info("Scanning for web services...")
        os.system(f"nmap -p 80,443,8080,8443 --open {network}")
        
        pause()
    
    def routing_info(self):
        """Network routing information"""
        self.show_header()
        Logger.info("Network Routing Information")
        Terminal.print_margin()
        
        Logger.info("Routing Table:")
        os.system("route -n")
        Terminal.print_margin()
        
        Logger.info("IP Route:")
        os.system("ip route show")
        Terminal.print_margin()
        
        Logger.info("Default Gateway:")
        os.system("ip route | grep default")
        
        pause()
    
    def active_connections(self):
        """Active network connections"""
        self.show_header()
        Logger.info("Active Network Connections")
        Terminal.print_margin()
        
        Logger.info("Established connections:")
        os.system("netstat -tunap | grep ESTABLISHED")
        Terminal.print_margin()
        
        Logger.info("Listening ports:")
        os.system("netstat -tulnp | grep LISTEN")
        
        pause()


if __name__ == "__main__":
    net_disc = NetworkDiscovery()
    net_disc.run()