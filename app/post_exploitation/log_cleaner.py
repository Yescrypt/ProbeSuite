#!/usr/bin/env python3
# app/post_exploitation/log_cleaner.py

import os
import sys

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, BASE_DIR)

from config import C_OK, C_WARN, C_ERR, C_RESET, C_INFO, C_TITLE
from utils import Logger, pause, InputValidator, clear_screen


class Terminal:
    MARGIN = 4
    
    @staticmethod
    def print_margin(text=""):
        margin = ' ' * Terminal.MARGIN
        if text:
            print(margin + text)
        else:
            print()


class LogCleaner:
    def show_header(self):
        clear_screen()
        Terminal.print_margin()
        Terminal.print_margin(f"{C_TITLE}╔════════════════════════════════════════╗{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}║           LOG CLEANING TOOLKIT         ║{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}╚════════════════════════════════════════╝{C_RESET}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_WARN}  WARNING: Educational purposes only!{C_RESET}")
        Terminal.print_margin()
    
    def run(self):
        while True:
            self.show_header()
            
            Terminal.print_margin(f"{C_TITLE}┌─ LOG CLEANING ──────────────────────┐{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  LINUX LOGS:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [1]  Clear Auth Logs{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [2]  Clear System Logs{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [3]  Clear Command History{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [4]  Clear Last Login Records{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  WINDOWS LOGS:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [5]  Clear Event Logs{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [6]  Clear PowerShell History{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  WEB LOGS:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [7]  Clear Apache Logs{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [8]  Clear Nginx Logs{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  UTILITIES:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [9]  Log File Locations{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [10] Timestamp Manipulation{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_WARN}  [0]  Back{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_TITLE}└─────────────────────────────────────┘{C_RESET}")
            Terminal.print_margin()
            
            choice = InputValidator.get_choice()
            
            if choice == '0':
                return
            elif choice == '1':
                self.clear_auth_logs()
            elif choice == '2':
                self.clear_system_logs()
            elif choice == '3':
                self.clear_history()
            elif choice == '4':
                self.clear_last_login()
            elif choice == '5':
                self.clear_event_logs()
            elif choice == '6':
                self.clear_powershell_history()
            elif choice == '7':
                self.clear_apache_logs()
            elif choice == '8':
                self.clear_nginx_logs()
            elif choice == '9':
                self.log_locations()
            elif choice == '10':
                self.timestamp_manipulation()
            else:
                Logger.error("Invalid choice!")
                pause()
    
    def clear_auth_logs(self):
        """Clear authentication logs"""
        self.show_header()
        Logger.info("Clear Authentication Logs")
        Terminal.print_margin()
        
        Logger.warning("This will clear login records!")
        Terminal.print_margin()
        
        auth_logs = [
            "/var/log/auth.log",
            "/var/log/secure",
            "/var/log/auth.log.1",
        ]
        
        Logger.info("Target files:")
        for log in auth_logs:
            Terminal.print_margin(f"  • {log}")
        
        Terminal.print_margin()
        Logger.info("Commands:")
        Terminal.print_margin(f"{C_OK}# Clear content{C_RESET}")
        Terminal.print_margin("echo '' > /var/log/auth.log")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Remove specific entries{C_RESET}")
        Terminal.print_margin("sed -i '/YOUR_IP/d' /var/log/auth.log")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Delete file{C_RESET}")
        Terminal.print_margin("rm -f /var/log/auth.log")
        Terminal.print_margin("touch /var/log/auth.log")
        
        pause()
    
    def clear_system_logs(self):
        """Clear system logs"""
        self.show_header()
        Logger.info("Clear System Logs")
        Terminal.print_margin()
        
        system_logs = [
            "/var/log/syslog",
            "/var/log/messages",
            "/var/log/kern.log",
            "/var/log/dmesg",
        ]
        
        Logger.info("System log files:")
        for log in system_logs:
            Terminal.print_margin(f"  • {log}")
        
        Terminal.print_margin()
        Logger.info("Clear all logs in /var/log:")
        Terminal.print_margin("find /var/log -type f -exec truncate -s 0 {} \\;")
        Terminal.print_margin()
        
        Logger.info("Selective cleaning:")
        Terminal.print_margin("for log in /var/log/*.log; do > $log; done")
        
        pause()
    
    def clear_history(self):
        """Clear command history"""
        self.show_header()
        Logger.info("Clear Command History")
        Terminal.print_margin()
        
        Logger.info("Bash history:")
        Terminal.print_margin(f"{C_OK}# Clear current session{C_RESET}")
        Terminal.print_margin("history -c")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Clear history file{C_RESET}")
        Terminal.print_margin("cat /dev/null > ~/.bash_history")
        Terminal.print_margin("rm ~/.bash_history")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Disable history for session{C_RESET}")
        Terminal.print_margin("unset HISTFILE")
        Terminal.print_margin("export HISTSIZE=0")
        Terminal.print_margin()
        
        Logger.info("Other history files:")
        Terminal.print_margin("  • ~/.zsh_history")
        Terminal.print_margin("  • ~/.mysql_history")
        Terminal.print_margin("  • ~/.python_history")
        
        pause()
    
    def clear_last_login(self):
        """Clear last login records"""
        self.show_header()
        Logger.info("Clear Last Login Records")
        Terminal.print_margin()
        
        Logger.info("Login record files:")
        Terminal.print_margin()
        
        records = [
            ("/var/log/wtmp", "Login history (who, last)"),
            ("/var/log/btmp", "Failed login attempts"),
            ("/var/log/lastlog", "Last login per user"),
            ("/var/run/utmp", "Currently logged in users"),
        ]
        
        for file, desc in records:
            Terminal.print_margin(f"{C_OK}{file:25s}{C_RESET} - {desc}")
        
        Terminal.print_margin()
        Logger.info("Clear commands:")
        Terminal.print_margin(f"{C_OK}# Clear wtmp{C_RESET}")
        Terminal.print_margin("echo '' > /var/log/wtmp")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Clear btmp{C_RESET}")
        Terminal.print_margin("echo '' > /var/log/btmp")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Clear lastlog{C_RESET}")
        Terminal.print_margin("echo '' > /var/log/lastlog")
        
        pause()
    
    def clear_event_logs(self):
        """Clear Windows event logs"""
        self.show_header()
        Logger.info("Clear Windows Event Logs")
        Terminal.print_margin()
        
        Logger.info("PowerShell commands:")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Clear all event logs{C_RESET}")
        Terminal.print_margin("wevtutil cl System")
        Terminal.print_margin("wevtutil cl Security")
        Terminal.print_margin("wevtutil cl Application")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Clear specific event log{C_RESET}")
        Terminal.print_margin("Clear-EventLog -LogName Application")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Clear all logs (PowerShell){C_RESET}")
        Terminal.print_margin("Get-EventLog -List | ForEach { Clear-EventLog $_.Log }")
        
        pause()
    
    def clear_powershell_history(self):
        """Clear PowerShell history"""
        self.show_header()
        Logger.info("Clear PowerShell History")
        Terminal.print_margin()
        
        Logger.info("PowerShell history location:")
        Terminal.print_margin("  %APPDATA%\\Microsoft\\Windows\\PowerShell\\PSReadLine\\")
        Terminal.print_margin()
        
        Logger.info("Clear commands:")
        Terminal.print_margin(f"{C_OK}# Clear current session{C_RESET}")
        Terminal.print_margin("Clear-History")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Delete history file{C_RESET}")
        Terminal.print_margin("Remove-Item (Get-PSReadlineOption).HistorySavePath")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Disable history{C_RESET}")
        Terminal.print_margin("Set-PSReadlineOption -HistorySaveStyle SaveNothing")
        
        pause()
    
    def clear_apache_logs(self):
        """Clear Apache logs"""
        self.show_header()
        Logger.info("Clear Apache Web Server Logs")
        Terminal.print_margin()
        
        Logger.info("Apache log locations:")
        Terminal.print_margin("  • /var/log/apache2/access.log")
        Terminal.print_margin("  • /var/log/apache2/error.log")
        Terminal.print_margin("  • /var/log/httpd/access_log")
        Terminal.print_margin("  • /var/log/httpd/error_log")
        Terminal.print_margin()
        
        Logger.info("Clear commands:")
        Terminal.print_margin(f"{C_OK}# Truncate logs{C_RESET}")
        Terminal.print_margin("truncate -s 0 /var/log/apache2/access.log")
        Terminal.print_margin("truncate -s 0 /var/log/apache2/error.log")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Remove specific IP{C_RESET}")
        Terminal.print_margin("sed -i '/YOUR_IP/d' /var/log/apache2/access.log")
        
        pause()
    
    def clear_nginx_logs(self):
        """Clear Nginx logs"""
        self.show_header()
        Logger.info("Clear Nginx Web Server Logs")
        Terminal.print_margin()
        
        Logger.info("Nginx log locations:")
        Terminal.print_margin("  • /var/log/nginx/access.log")
        Terminal.print_margin("  • /var/log/nginx/error.log")
        Terminal.print_margin()
        
        Logger.info("Clear commands:")
        Terminal.print_margin(f"{C_OK}# Truncate logs{C_RESET}")
        Terminal.print_margin("truncate -s 0 /var/log/nginx/access.log")
        Terminal.print_margin("truncate -s 0 /var/log/nginx/error.log")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Reload nginx after clearing{C_RESET}")
        Terminal.print_margin("systemctl reload nginx")
        
        pause()
    
    def log_locations(self):
        """Common log file locations"""
        self.show_header()
        Logger.info("Common Log File Locations")
        Terminal.print_margin()
        
        Logger.info("Linux Logs:")
        Terminal.print_margin()
        
        linux_logs = [
            "/var/log/auth.log",
            "/var/log/syslog",
            "/var/log/kern.log",
            "/var/log/apache2/",
            "/var/log/nginx/",
            "/var/log/mysql/",
            "~/.bash_history",
            "/var/log/wtmp",
            "/var/log/btmp",
        ]
        
        for log in linux_logs:
            Terminal.print_margin(f"  • {log}")
        
        Terminal.print_margin()
        Logger.info("Windows Logs:")
        Terminal.print_margin("  • Event Viewer logs")
        Terminal.print_margin("  • %APPDATA%\\Microsoft\\Windows\\PowerShell\\PSReadLine\\")
        Terminal.print_margin("  • C:\\Windows\\System32\\winevt\\Logs\\")
        
        pause()
    
    def timestamp_manipulation(self):
        """File timestamp manipulation"""
        self.show_header()
        Logger.info("File Timestamp Manipulation")
        Terminal.print_margin()
        
        Logger.info("Linux - touch command:")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Set specific date{C_RESET}")
        Terminal.print_margin("touch -t 202301010000 file.txt")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Copy timestamps from another file{C_RESET}")
        Terminal.print_margin("touch -r original.txt fake.txt")
        Terminal.print_margin()
        
        Logger.info("Timestomp (Windows):")
        Terminal.print_margin("timestomp.exe file.exe -z \"01/01/2020 00:00:00\"")
        Terminal.print_margin()
        
        Logger.info("This changes:")
        Terminal.print_margin("  • Access time (atime)")
        Terminal.print_margin("  • Modification time (mtime)")
        Terminal.print_margin("  • Change time (ctime)")
        
        pause()


if __name__ == "__main__":
    log_clean = LogCleaner()
    log_clean.run()